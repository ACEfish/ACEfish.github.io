
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>
    
  多线程 - ACEfish-Blog
  

  </title>
  <meta name="author" content="">
  <meta name="description" content="学习记录">

  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link href="asset/css/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="atom.xml" rel="alternate" title="ACEfish-Blog" type="application/atom+xml">
  <script src="asset/js/modernizr-2.0.js"></script>
  <script src="asset/js/jquery.min.js"></script>
  <script src="asset/highlightjs/highlight.pack.js"></script>
  <link href="asset/highlightjs/styles/solarized_light.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script>hljs.initHighlightingOnLoad();</script>

  <style type="text/css">
  .cat-children-p{ padding: 6px 0px;}
  .hljs{background: none;}
  </style>
  <script type="text/javascript">
  var isAddSildbar = true;
  </script>
  <script src="asset/js/octopress.js" type="text/javascript"></script>
</head>
<script type="text/javascript">
//链接新开窗口
function addBlankTargetForLinks () {
  $('a[href^="http"]').each(function(){
      $(this).attr('target', '_blank');
  });
}
$(document).ready(function(event) {
  addBlankTargetForLinks();
});
</script>
<body   >
  <header role="banner"><hgroup>
  <h1><a href="index.html">ACEfish-Blog</a></h1>
  
    <h2>学习记录</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:acefish.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">

  <li id=""><a target="_self" href="index.html">首页</a></li>

  <li id=""><a target="_self" href="archives.html">归档</a></li>

</ul>

</nav>
  <div id="main">
    <div id="content"> 
<div class="blog-index">

	<article>
		 <header>
		  	<h1 class="entry-title"><a href="15548649461552.html">dispatch_block_t</a></h1>
			<p class="meta"><time datetime="2019-04-10T10:55:46+08:00" 
			pubdate data-updated="true">2019/4/10</time></p>
		 </header>
	  	<div class="entry-content">
		  	
		  	<h4 id="toc_0">dispatch_block_t</h4>

<p><code>typedef void (^dispatch_block_t)(void);</code></p>

<p>注意:<br/>
声明的block是分配在stack上的</p>

<pre><code class="language-objectivec">//下面写法是错误的
dispatch_block_t block;
if (x) {
block = ^{ printf(&quot;true\n&quot;); };
} else {
block = ^{ printf(&quot;false\n&quot;); };
}
block();
</code></pre>

<p>block是在栈上的，当<code>{}</code>退出时，block就无效了</p>

<h4 id="toc_1">dispatch_block_create_with_qos_class</h4>

<p>在堆上创建新的dispatch block，指定其执行block，分配指定的<code>QoS</code>类和相对优先级</p>

<pre><code class="language-objectivec">dispatch_block_t dispatch_block_create_with_qos_class(dispatch_block_flags_t flags, dispatch_qos_class_t qos_class, int relative_priority, dispatch_block_t block);
//flags 设置block的标记 必须为有效的位标记，否则返回NULL
//qos_class QoS类， 这个值传QOS_CLASS_UNSPECIFIED 相当于DISPATCH_BLOCK_NO_QOS_CLASSflag
//指定qos类的相对优先级 越大优先级越高 为负值 不能赋值给其大于0 小于QOS_MIN_RELATIVE_PRIORITY的值 否则会返回NULL
</code></pre>

<blockquote>
<p>提供的参数block会被copy到堆上，被新创建的dispatch block持有</p>

<p>这个block可以<code>dispatch_async</code>到queue中执行或者直接执行<br/>
block可以用这两种方式多次执行，但是只有第一次执行的block可以被<code>dispatch_block_wait</code>等待或者<code>dispatch_block_notify.</code>监听</p>

<p>直接执行时，如果分配的QoS类比调用的线程的QoS类优先级高，则使用分配的QoS类执行<br/>
如果dispatch block到queue中执行，则执行它的QoS类取决于分配给bloc的QoS，queue的QoS或者flags共同决定<br/>
如果block被直接提交到串行队列执行，则QoS类无效，系统会尽力覆盖QoS使先执行的block的QoS类等级更高，优先执行</p>
</blockquote>

<pre><code class="language-objectivec">//flag的类型
DISPATCH_ENUM(dispatch_block_flags, unsigned long,
    DISPATCH_BLOCK_BARRIER = 0x1,
    /**
    当在一个DISPATCH_QUEUE_CONCURRENT的queue中执行dispatch block时
    表明这个block是barrier，即使不使用dispatch_barrier_async函数也可以在起到栅栏作用
    在直接执行dispatch block时，这个flags无效
    */
    DISPATCH_BLOCK_DETACHED = 0x2,
    /**
    将dispatch block与当前执行的context(上下文)分离
    */
    DISPATCH_BLOCK_ASSIGN_CURRENT = 0x4,
    /**
    指定dispatch block使用当前执行的context
    */
    DISPATCH_BLOCK_NO_QOS_CLASS = 0x8,
    /**
    表示不为block分配QoS类
    直接执行block，则使用调用线程的QoS
    如果给该block分配了特定QoS类，则该flag设置无效，忽略
    */
    DISPATCH_BLOCK_INHERIT_QOS_CLASS = 0x10,
    /**
        Queue的QoS类优先于block的QoS类，只有当队列没有QoS时才会使用block的QoS
        在直接调用block时，该flags值无效
        将block提交到queue中异步执行时，该值为默认值
        当设置了DISPATCH_BLOCK_ENFORCE_QOS_CLASS时，该default flag被忽略
    */
    DISPATCH_BLOCK_ENFORCE_QOS_CLASS = 0x20,
    /**
        表示当block的QoS类优先级高于Queue的QoS类时，优先选择block的QoS类
        当直接执行block或者将block提交到Queue中进行同步执行时，此为默认值
    */
);
</code></pre>

<blockquote>
<p><code>DISPATCH_BLOCK_BARRIER</code>即在自己创建的并行队列中 做栅栏block</p>

<p><code>DISPATCH_BLOCK_DETACHED</code>、<code>DISPATCH_BLOCK_ASSIGN_CURRENT</code>、<code>DISPATCH_BLOCK_NO_QOS_CLASS</code>用于<code>dispatch_block_create</code>函数，而在<code>dispatch_block_create_with_qos_class</code>中指定了QoS类，该flag就失效了</p>
</blockquote>

<p><a href="https://developer.apple.com/library/archive/documentation/Performance/Conceptual/power_efficiency_guidelines_osx/RelatedDocuments.html#//apple_ref/doc/uid/TP40013929-CH20-SW16">Quality of Service Classes (QoS).</a></p>

<pre><code class="language-objectivec">__QOS_ENUM(qos_class, unsigned int,
    QOS_CLASS_USER_INTERACTIVE = 0x21,
        /**
          表示任务需要被立即执行 响应事件更新UI 用来处理主事件循环、视图绘制、动画等
        */
    QOS_CLASS_USER_INITIATED = 0x19,
        /**
          表示任务由UI发起异步任务。等待结果
        */
    QOS_CLASS_DEFAULT = 0x15,
        /**
          默认优先级
        */
    QOS_CLASS_UTILITY = 0x11,
        /**
          表示需要长时间运行任务，伴有进度指示器；用来做计算、I/O,网络，持续数据填充等
        */
    QOS_CLASS_BACKGROUND = 0x09,
        /**
          表示用户不需要察觉的任务，用来预处理加载
        */
    QOS_CLASS_UNSPECIFIED = 0x00,
        /**
          未指明
        */
);
</code></pre>

<h4 id="toc_2">dispatch_block_create</h4>

<pre><code class="language-objectivec">dispatch_block_t dispatch_block_create(dispatch_block_flags_t flags, dispatch_block_t block);
//flags 设置block的标记 必须为有效的位标记，否则返回NULL 与上面的flag相同
//block设置具体任务 block将会copy到新的dispatch block中
</code></pre>

<blockquote>
<p>当返回的dispath block被提交到queue中执行时，block与当前提交时的QoS类相关联，除非有以下flags在创建block时指定了QoS类(或者不指定QoS类):<br/>
<code>DISPATCH_BLOCK_ASSIGN_CURRENT</code><br/>
<code>DISPATCH_BLOCK_NO_QOS_CLASS</code><br/>
<code>DISPATCH_BLOCK_DETACHED</code></p>

<p>当dispatch block在queue中执行时，则执行它的QoS类取决于分配给bloc的QoS，queue的QoS或者flags共同决定:<br/>
<code>DISPATCH_BLOCK_INHERIT_QOS_CLASS</code>(异步执行默认值)<br/>
<code>DISPATCH_BLOCK_INHERIT_QOS_CLASS</code>(同步执行默认值)</p>
</blockquote>

<h2 id="toc_3">dispatch_block_perform</h2>

<pre><code class="language-objectivec">void dispatch_block_perform(dispatch_block_flags_t flags, dispatch_block_t block);
</code></pre>

<p>通过指定<code>flag</code>和block，<strong>同步</strong>执行该block，并且release生成的dispatchBlock</p>

<p>这个函数相当于下面这段代码:<br/>
并且与下面这段代码相比，不需要将block copy到堆上开辟新的内存，在内部更高效的实现</p>

<pre><code class="language-objectivec">dispatch_block_t b = dispatch_block_create(flags, block);
b();
Block_release(b);
</code></pre>

<h2 id="toc_4">dispatch_block_wait</h2>

<p><strong>同步</strong>等待dispatch Block执行完成 或者 超时<br/>
会阻塞当前线程 </p>

<pre><code class="language-obj">long dispatch_block_wait(dispatch_block_t block, dispatch_time_t timeout);
//block: 应该为dispatch_block_create 或者dispatch_block_create_with_qos_class 创建的block
//超时时间:  
//返回值: 如果执行block时间小于超时时间返回0，否则返回非0
</code></pre>

<p><strong>同一个block只会被等待一次，执行多次，也只能同时被一个等待</strong></p>

<blockquote>
<ol>
<li>dispatch_block_wait 只会监听第一个block执行情况，如果已经执行过一次了，这个函数就会立即返回</li>
<li>请使用<code>dispatch_group_wait</code>监听统一block的多次执行</li>
<li>不能在多线程中同时执行该函数等待同一个block返回，因为block只能等待一次</li>
<li>如果该函数返回超时，则这次等待不算，即还可以再次等待block完成，否则只能等待一次</li>
<li>提交到queue执行block即使立即用<code>dispatch_block_cancel</code>使其不执行，这也算执行过一次了</li>
</ol>
</blockquote>

<h2 id="toc_5">dispatch_block_notify</h2>

<p>监听block执行完成，将要执行的block放入queue指定queue中执行</p>

<pre><code class="language-objectivec">void dispatch_block_notify(dispatch_block_t block, dispatch_queue_t queue, dispatch_block_t notification_block);
//block: 监听的block  应该为dispatch_block_create 或者dispatch_block_create_with_qos_class 创建的block
//queue
//notification_block: 当监听的block执行完成 执行的block
</code></pre>

<blockquote>
<ol>
<li>当监听的block已经完成 该监听block会立即执行</li>
<li>无法监听相同block的多次执行的，请使用<code>dispatch_group_notify</code></li>
<li><strong>block可以执行一次 监听多次</strong></li>
<li>如果多个监听统一block执行，不能预期监听的block执行顺序</li>
<li>提交到queue执行block即使立即用<code>dispatch_block_cancel</code>使其不执行，这也算执行过一次了</li>
</ol>
</blockquote>

<h2 id="toc_6">dispatch_block_cancel</h2>

<p>异步取消指定<code>dispatch block</code></p>

<pre><code class="language-objectivec">void dispatch_block_cancel(dispatch_block_t block);
//block： 应该使用dispatch_block_create 或者dispatch_block_create_with_qos_class 创建的block
</code></pre>

<p>对于所有未执行的block去 立即返回并不执行，但是对于那些已经在执行的 则没有影响</p>

<p>注意: 确保可能被取消的block不持有任何需要执行block才会释放的资源，例如malloc内存，否则由于永远不执行block块导致内存泄漏</p>

<blockquote>
<p>已经被cancel的block无法再执行</p>
</blockquote>

<h4 id="toc_7">dispatch_block_testcancel</h4>

<p>测试是否这个block已经被取消</p>

<pre><code class="language-objectivec">long dispatch_block_testcancel(dispatch_block_t block);
//返回: 被取消的话返回非0，否则返回0
</code></pre>


		</div>

		

	</article>
  
	<div class="pagination">
	 <a class="prev" href="多线程_3.html">&larr; Older</a> 
<a href="archives.html">Blog Archives</a>
	 <a class="next" href="多线程_1.html">Newer &rarr;</a>  
	    
	</div>
</div>
 <aside class="sidebar"> 

	<section>
	  <h1>Categories</h1>
	  <ul id="recent_posts">
	  
	      <li class="post">
	        <a href="iOS%20%E5%BC%80%E5%8F%91%E6%A8%A1%E5%9D%97%E7%9F%A5%E8%AF%86.html"><strong>iOS 开发模块知识&nbsp;(172)</strong></a>
	         <p class="cat-children-p"> 
	        
	        	<a href="iOS%E7%BC%96%E8%AF%91.html">iOS编译&nbsp;(20)</a>&nbsp;&nbsp;
	        
	        	<a href="%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86&Block.html">内存管理&Block&nbsp;(18)</a>&nbsp;&nbsp;
	        
	        	<a href="RunTime.html">runtime&nbsp;(11)</a>&nbsp;&nbsp;
	        
	        	<a href="Concurrent-Programming.html">多线程&nbsp;(19)</a>&nbsp;&nbsp;
	        
	        	<a href="GPU&&%E6%B8%B2%E6%9F%93.html">GPU&&渲染&nbsp;(3)</a>&nbsp;&nbsp;
	        
	        	<a href="%E6%9E%B6%E6%9E%84%E5%AD%A6%E4%B9%A0.html">架构学习&nbsp;(8)</a>&nbsp;&nbsp;
	        
	        	<a href="%E7%AC%AC%E4%B8%89%E6%96%B9%E9%A1%B9%E7%9B%AE%E5%AD%A6%E4%B9%A0.html">第三方项目学习&nbsp;(20)</a>&nbsp;&nbsp;
	        
	        	<a href="%E9%A1%B9%E7%9B%AE%E7%9B%91%E6%8E%A7.html">项目监控&nbsp;(10)</a>&nbsp;&nbsp;
	        
	        	<a href="%E6%B5%8B%E8%AF%95.html">调试&&测试&nbsp;(5)</a>&nbsp;&nbsp;
	        
	        	<a href="Cocoapods.html">Cocoapods&nbsp;(4)</a>&nbsp;&nbsp;
	        
	        	<a href="%E6%A8%A1%E5%9D%97%E5%8C%96%E7%9F%A5%E8%AF%86%E5%AD%A6%E4%B9%A0.html">模块化知识学习&nbsp;(26)</a>&nbsp;&nbsp;
	        
	        	<a href="Instrument%E5%AD%A6%E4%B9%A0.html">Instrument学习&nbsp;(1)</a>&nbsp;&nbsp;
	        
	        	<a href="%E7%9F%A5%E8%AF%86%E7%82%B9.html">知识点&nbsp;(10)</a>&nbsp;&nbsp;
	        
	        	<a href="%E8%A1%A5%E5%85%85-1.html">补充&nbsp;(9)</a>&nbsp;&nbsp;
	        
	        	<a href="%E9%9D%A2%E8%AF%95.html">面试&nbsp;(8)</a>&nbsp;&nbsp;
	        
	         </p> 
	      </li>
	  
	      <li class="post">
	        <a href="Swift.html"><strong>Swift初学笔记&nbsp;(28)</strong></a>
	         <p class="cat-children-p"> 
	        
	        	<a href="Swift-BaseLearning.html">Swift基础知识&nbsp;(28)</a>&nbsp;&nbsp;
	        
	         </p> 
	      </li>
	  
	      <li class="post">
	        <a href="Computer-programming.html"><strong>计算机编程&nbsp;(2)</strong></a>
	        
	        
	        
	      </li>
	  
	      <li class="post">
	        <a href="iOSDevelop.html"><strong>iOSDevelop&nbsp;(27)</strong></a>
	         <p class="cat-children-p"> 
	        
	        	<a href="iOS%20%E5%B0%8F%E7%9F%A5%E8%AF%86.html">iOS 小知识&nbsp;(14)</a>&nbsp;&nbsp;
	        
	        	<a href="iOS%E5%BC%80%E5%8F%91%E7%9F%A5%E8%AF%86.html">iOS开发知识&nbsp;(12)</a>&nbsp;&nbsp;
	        
	         </p> 
	      </li>
	  
	      <li class="post">
	        <a href="JavaScript%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html"><strong>JavaScript学习笔记&nbsp;(41)</strong></a>
	         <p class="cat-children-p"> 
	        
	        	<a href="%E5%9F%BA%E7%A1%80.html">基础&nbsp;(11)</a>&nbsp;&nbsp;
	        
	        	<a href="%E7%9F%A5%E8%AF%86%E6%99%AE%E5%8F%8A.html">知识普及&nbsp;(1)</a>&nbsp;&nbsp;
	        
	        	<a href="Flex.html">Flex&nbsp;(2)</a>&nbsp;&nbsp;
	        
	        	<a href="ES6.html">ES6&nbsp;(17)</a>&nbsp;&nbsp;
	        
	        	<a href="React.html">React&nbsp;(10)</a>&nbsp;&nbsp;
	        
	         </p> 
	      </li>
	  
	      <li class="post">
	        <a href="React-Native.html"><strong>React-Native&nbsp;(6)</strong></a>
	        
	        
	        
	      </li>
	  
	      <li class="post">
	        <a href="Python.html"><strong>Python&nbsp;(14)</strong></a>
	        
	        
	        
	      </li>
	  
	      <li class="post">
	        <a href="%E7%AE%97%E6%B3%95%E5%AD%A6%E4%B9%A0.html"><strong>算法学习&nbsp;(2)</strong></a>
	         <p class="cat-children-p"> 
	        
	        	<a href="%E7%AE%97%E6%B3%95%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0.html">算法读书笔记&nbsp;(2)</a>&nbsp;&nbsp;
	        
	         </p> 
	      </li>
	   
	  </ul>
	</section>
	<section>
	  <h1>Recent Posts</h1>
	  <ul id="recent_posts">
	  
	      
		      <li class="post">
		        <a href="15680194937623.html">AFSecurityPolicy</a>
		      </li>
	     
	  
	      
		      <li class="post">
		        <a href="15680125238227.html">AFNetworkReachabilityManager</a>
		      </li>
	     
	  
	      
		      <li class="post">
		        <a href="15677400518331.html">AFURLSerialization</a>
		      </li>
	     
	  
	      
		      <li class="post">
		        <a href="15676621460215.html">AFURLSessionManager</a>
		      </li>
	     
	  
	      
		      <li class="post">
		        <a href="15675682575589.html">AFNetworking</a>
		      </li>
	     
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	   
	  </ul>
	</section>
	
</aside> </div></div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 -  -
  <span class="credit">Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a> &nbsp;&nbsp; Theme by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>

  
    




</body>
</html>