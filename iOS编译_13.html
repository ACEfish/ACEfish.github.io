
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>
    
  iOS编译 - ACEfish-Blog
  

  </title>
  <meta name="author" content="">
  <meta name="description" content="学习记录">

  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link href="asset/css/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="atom.xml" rel="alternate" title="ACEfish-Blog" type="application/atom+xml">
  <script src="asset/js/modernizr-2.0.js"></script>
  <script src="asset/js/jquery.min.js"></script>
  <script src="asset/highlightjs/highlight.pack.js"></script>
  <link href="asset/highlightjs/styles/solarized_light.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script>hljs.initHighlightingOnLoad();</script>

  <style type="text/css">
  .cat-children-p{ padding: 6px 0px;}
  .hljs{background: none;}
  </style>
  <script type="text/javascript">
  var isAddSildbar = true;
  </script>
  <script src="asset/js/octopress.js" type="text/javascript"></script>
</head>
<script type="text/javascript">
//链接新开窗口
function addBlankTargetForLinks () {
  $('a[href^="http"]').each(function(){
      $(this).attr('target', '_blank');
  });
}
$(document).ready(function(event) {
  addBlankTargetForLinks();
});
</script>
<body   >
  <header role="banner"><hgroup>
  <h1><a href="index.html">ACEfish-Blog</a></h1>
  
    <h2>学习记录</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:acefish.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">

  <li id=""><a target="_self" href="index.html">首页</a></li>

  <li id=""><a target="_self" href="archives.html">归档</a></li>

</ul>

</nav>
  <div id="main">
    <div id="content"> 
<div class="blog-index">

	<article>
		 <header>
		  	<h1 class="entry-title"><a href="15538518127841.html">App程序编译的完整流程</a></h1>
			<p class="meta"><time datetime="2019-03-29T17:30:12+08:00" 
			pubdate data-updated="true">2019/3/29</time></p>
		 </header>
	  	<div class="entry-content">
		  	
		  	<p>本文学习自戴铭老师的<a href="https://github.com/ming1016/study/wiki/%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90-iOS-%E7%BC%96%E8%AF%91-Clang---LLVM">深入剖析 iOS 编译 Clang LLVM</a></p>

<h2 id="toc_0">前言</h2>

<p>每次项目编译 不论模拟器还是真机都会在<code>Xcode</code>的<code>DerivedData</code>文件夹下创建一个该次编译需要或者产生文件的文件夹(缓存文件夹)<br/>
<img src="media/15538518127841/15538525190405.jpg" alt="" style="width:624px;"/></p>

<p>而在build文件夹中就是我们这次编译的主要信息<br/>
<img src="media/15538518127841/15538525902894.jpg" alt="" style="width:820px;"/><br/>
其中<code>Intermediates.noindex</code>文件夹中为编译的缓存文件(辅助文件)，主要为辅助文件<code>.yml</code><code>.hamp</code>等<br/>
product中为我们编译的结果<br/>
<img src="media/15538518127841/15538527710516.jpg" alt="" style="width:592px;"/><br/>
包括了pod库打包的.a文件，安装用到的.app文件，.app中还包括资源文件、.plist文件、storybord或者xib编译后的nib文件等</p>

<p><img src="media/15538518127841/15538542741556.jpg" alt="" style="width:203px;"/></p>

<h2 id="toc_1">编译流程</h2>

<p>在本文中我们编译一个cocopoda程序来做演示</p>

<h3 id="toc_2">1. 编译信息写入辅助文件，创建文件架构.app文件</h3>

<p>创建.app文件夹,用来存放最后生成.app文件的信息<br/>
<img src="media/15538518127841/15538531245953.jpg" alt="" style="width:837px;"/></p>

<p>辅助文件用于辅助编译，暂时不知道有什么其他用？？？？</p>

<p>写入辅助文件.yaml文件<br/>
<img src="media/15538518127841/15538520286678.jpg" alt="" style="width:824px;"/></p>

<p>写入辅助文件.hamp文件<br/>
<img src="media/15538518127841/15538520549132.jpg" alt="" style="width:838px;"/><br/>
写入辅助文件Entitlements.plist 和 Entitlements-Simulated.plist<br/>
<img src="media/15538518127841/15538536658391.jpg" alt="" style="width:818px;"/></p>

<h3 id="toc_3">2. 处理文件的打包信息</h3>

<p>1.真机打包文件: 真机需要配置文件信息,此时在.app文件夹下为<br/>
包含了配置文件信息是应用程序能在真机上运行的必须<br/>
这步即将电脑内存放的开发证书证书直接放置到.app文件夹中<br/>
<img src="media/15538518127841/15538540868414.jpg" alt="" style="width:879px;"/><br/>
见上图中<code>embedded.mobileprovision</code>文件</p>

<p>1.2 模拟器打包文件<br/>
模拟器的配置文件信息，是app能在模拟器上运行的必须<br/>
<img src="media/15538518127841/15538544375164.jpg" alt="" style="width:1098px;"/></p>

<p>2.打包文件的实体信息 .app.xcent 主要为Entilements，信息  （不论模拟器或者真机都有）真机的文件信息中 包括了app信息，开发者信息、app用到的权限信息等<br/>
 <img src="media/15538518127841/15538542169158.jpg" alt="" style="width:840px;"/></p>

<h3 id="toc_4">3. 执行 CocoaPod 编译前脚本，checkPods Manifest.lock</h3>

<p>默认是在这一步执行，这和你放置这个脚本的位置有关</p>

<p><img src="media/15538518127841/15538558869448.jpg" alt="" style="width:684px;"/></p>

<p><img src="media/15538518127841/15538547657710.jpg" alt="" style="width:834px;"/></p>

<p><img src="media/15538518127841/15538547101237.jpg" alt="" style="width:701px;"/></p>

<p>执行脚本比较这两个.lock文件 判断是否差异</p>

<h3 id="toc_5">4.编译.m文件，使用 CompileC 和 clang 命令</h3>

<p>编译所有的.m文件，包括自己项目的和pod库中的,（为什么没有.h文件呢？因为在预编译的时候都进了其它.m文件啊）</p>

<p>编译后生成.o文件</p>

<p><img src="media/15538518127841/15538550281496.jpg" alt="" style="width:864px;"/></p>

<p>首先对任务进行描述</p>

<pre><code class="language-text">CompileC /Users/fish/Library/Developer/Xcode/DerivedData/AlipayDemo-bqmyunxtybyzyecoutybsvekthlo/Build/...
</code></pre>

<p>接下来对会更新工作路径</p>

<pre><code class="language-text">cd /Users/fish/Desktop/AlipayDemo
export LANG=en_US.US-ASCII
</code></pre>

<p>接下来就是实际的编译命令</p>

<pre><code class="language-text">//调用了clang命名
/Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/clang -x objective-c -arch arm64 -fmessage-length=0 -fdiagnostics-show-note-include-stack -fmacro-backtrace-limit=0 -std=gnu11 -fobjc-arc -fobjc-weak -fmodules -gmodules -fmodules-cache-path=/Users/fi....
</code></pre>

<pre><code class="language-text">//将pch文件一起编译
-include /Users.../Application/PrefixHeader.pch
</code></pre>

<p>将文件都编译完成后,会将所有的.o文件写入一个辅助文件 <code>.LinkFileList</code>文件中，便于下一步链接</p>

<p>clang常用命令参数</p>

<pre><code class="language-text">-x 编译语言比如objective-c
-arch 编译的架构，比如arm7
-f 以-f开头的。
-W 以-W开头的，可以通过这些定制编译警告
-D 以-D开头的，指的是预编译宏，通过这些宏可以实现条件编译
-iPhoneSimulator10.1.sdk 编译采用的iOS SDK版本
-I 把编译信息写入指定的辅助文件
-c 标识符指明需要运行预处理器，语法分析，类型检查，LLVM生成优化以及汇编代码生成.o文件
-F 需要的Framework
-L 连接静态库
-o 编译结果
-inclue 将文件include一起编译(当我们添加的有prefix文件时，就会在这这一步一起编译)
</code></pre>

<h3 id="toc_6">5.将cocoapods中的pod生成.a静态库</h3>

<p><img src="media/15538518127841/15538703095401.jpg" alt="" style="width:1031px;"/></p>

<p>使用<code>libTool</code>命令,<br/>
<code>-fileList</code>指定上一步编译的所有.o文件等，其记录在一个AFNetworking.LinkFileList的文件中<br/>
<code>-framework</code>指定需要依赖的framework <br/>
打包为一个.a静态库</p>

<blockquote>
<p>swift的话，因为其pod不支持静态库，我们一般podfile中指定 userFramework？？？</p>
</blockquote>

<h3 id="toc_7">6.链接需要的 Framework和library</h3>

<p><img src="media/15538518127841/15538692299741.jpg" alt="" style="width:1050px;"/></p>

<p>采用 clang <br/>
-L 链接静态库<br/>
-framework 添加需要的依赖系统库库<br/>
-F 链接framework</p>

<p>链接的内容包括:</p>

<ol>
<li>pod库生成的.a文件 即libPods-[ProjectName].a文件</li>
<li>pod库打包生成的.a文件,例如libAFNetworking.a等链接到工程</li>
<li>需要的外部framework文件</li>
<li>-fileList 将上一步编译生成的所有.o文件 记录在.buile/.LinkFileList中,链接所以工程文件</li>
<li>以及其他的一些辅助文件</li>
<li>链接需要的系统库</li>
</ol>

<p>生成项目程序的可执行文件就是一个脚本文件</p>

<h3 id="toc_8">7. 处理资源文件</h3>

<h4 id="toc_9">编译 ImageAssets</h4>

<p>即使多个.xcassets也是一起编译的，而不是分开编译多次</p>

<p><img src="media/15538518127841/15538746736648.jpg" alt="" style="width:1078px;"/></p>

<p>使用<code>actool</code>命令 这个命令只用于这个地方<br/>
<code>--output-format human-readable-text</code><br/>
<code>--export-dependency-info</code> 将编译后的生成的文件信息记录在.build文件夹下的assetcatalog_dependencies文件中,包括.xcassets文件、appIcon图片、launchImage图片、生成的唯一.car文件、记录信息的.plist文件</p>

<p><code>--output-partial-info-plist</code> 生成一个.build/assetcatalog_generated_info.plist ,主要记录了appIcon和launchImage信息<br/>
<img src="media/15538518127841/15538756202833.jpg" alt="" style="width:702px;"/></p>

<p><code>--app-icon AppIcon</code><br/>
<code>--launch-image LaunchImage</code><br/>
<code>--compress-pngs --enable-on-demand-resources YES</code></p>

<p><code>--filter-for-device-model iPhone10,3 --filter-for-device-os-version 12.2 --target-device iphone</code> 当前的设备信息</p>

<p><code>--target-device iphone --minimum-deployment-target 8.0</code><br/>
<code>--compile</code>  将编译生成的.car信息直接放入.app文件夹中<br/>
将appIcon、LaunchImage图片文件放入.app文件中</p>

<h4 id="toc_10">编译 xib</h4>

<p>xib编译</p>

<p><code>ibtool</code>命令<br/>
<code>--module</code>指定所属模块名称<br/>
<code>--target-device</code>指定面向设备，iPhone/iPad<br/>
<code>--auto-activate-custom-fonts</code><br/>
<code>--minimum-deployment-target 8.0</code> 最低支持目标设备系统</p>

<p><code>--output-partial-info-plist</code> 生成一个-PartialInfo.plist文件 放置在.build文件的辅助文件中</p>

<p><code>--output-format human-readable-text</code><br/>
<code>--compile</code> 编译生成一个nib文件,直接放置在.app文件中</p>

<p><img src="media/15538518127841/15538725620996.jpg" alt="" style="width:834px;"/></p>

<h4 id="toc_11">编译 storyBoard</h4>

<p><img src="media/15538518127841/15538729971749.jpg" alt="" style="width:905px;"/></p>

<p>类似编译xib<br/>
<code>ibtool</code>命令<br/>
<code>--module</code>指定所属模块名称<br/>
<code>--output-partial-info-plist</code> 生成一个 <code>/Base.lproj/Name-SBPartialInfo.plist</code>文件 存放在<code>.build</code>文件夹中<br/>
<code>--target-device iphone --target-device ipad</code><br/>
<code>--minimum-deployment-target 8.0</code><br/>
<code>--output-format human-readable-text</code> <br/>
<code>--compilation-directory</code> 编译生成.storyboardc文件,放在<code>.build</code>文件中<br/>
<img src="media/15538518127841/15538719624665.jpg" alt="" style="width:630px;"/></p>

<h4 id="toc_12">链接storyBoard文件</h4>

<p><img src="media/15538518127841/15538732881268.jpg" alt="" style="width:887px;"/></p>

<p>使用<code>ibtool</code>命令<br/>
指定一些信息<br/>
<code>--module</code>指定所属模块名称<br/>
<code>--target-device iphone --target-device ipad --minimum-deployment-target 8.0</code><br/>
<code>--output-format human-readable-text</code><br/>
<code>--link</code>将项目模块中所有上一步生成的<code>.storyboardc</code>文件连接到 .app文件夹中</p>

<h4 id="toc_13">拷贝xib、资源文件</h4>

<p>拷贝一些资源文件到我们创建.app文件中</p>

<h4 id="toc_14">处理 info.plist文件</h4>

<p><img src="media/15538518127841/15538764050221.jpg" alt="" style="width:958px;"/></p>

<p><code>-genpkginfo</code> 在.app文件夹下，生成了PkgInfo文件 ???<br/>
<code>-additionalcontentfile</code>加入多个前面生成的plist文件<br/>
<code>-o</code>将合并信息 生成为info.plist,放置在.app文件夹下</p>

<h3 id="toc_15">8. 生成符号表文件(GenerateDSYMFile)</h3>

<p>利用可执行文件中的符号表 生成 符号表文件 .dSYM<br/>
当设置build setting中-&gt;build option -&gt; dysm 符号表为 -&gt; dwarf-dYSM时会生产该文件 默认debug不生成 release生成<br/>
<img src="media/15538518127841/15560737675622.jpg" alt="" style="width:871px;"/></p>

<h3 id="toc_16">9. 裁剪掉app文件中的符号表</h3>

<p>这是只在archive app中才会执行这一步<br/>
<img src="media/15538518127841/15560737281876.jpg" alt="" style="width:885px;"/></p>

<h3 id="toc_17">8. 执行 一些自定义 脚本</h3>

<pre><code class="language-text">这个地方可以执行一些自定义脚本，具体执行位置还是要看 在`build Phases`中的自定义顺序
</code></pre>

<h3 id="toc_18">9. 签名 验证</h3>

<p>主要用于真机<br/>
使用<code>codesign</code>命令,利用我们之前生成的.app.xcent信息 进行应用签名</p>

<h3 id="toc_19">10. 创建 .app 文件</h3>

<p>生成.app文件 即最终的可安装文件<br/>
<img src="media/15538518127841/15538768732306.jpg" alt="" style="width:1057px;"/></p>


		</div>

		

	</article>
  
	<div class="pagination">
	 <a class="prev" href="iOS编译_14.html">&larr; Older</a> 
<a href="archives.html">Blog Archives</a>
	 <a class="next" href="iOS编译_12.html">Newer &rarr;</a>  
	    
	</div>
</div>
 <aside class="sidebar"> 

	<section>
	  <h1>Categories</h1>
	  <ul id="recent_posts">
	  
	      <li class="post">
	        <a href="iOS%20%E5%BC%80%E5%8F%91%E6%A8%A1%E5%9D%97%E7%9F%A5%E8%AF%86.html"><strong>iOS 开发模块知识&nbsp;(172)</strong></a>
	         <p class="cat-children-p"> 
	        
	        	<a href="iOS%E7%BC%96%E8%AF%91.html">iOS编译&nbsp;(20)</a>&nbsp;&nbsp;
	        
	        	<a href="%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86&Block.html">内存管理&Block&nbsp;(18)</a>&nbsp;&nbsp;
	        
	        	<a href="RunTime.html">runtime&nbsp;(11)</a>&nbsp;&nbsp;
	        
	        	<a href="Concurrent-Programming.html">多线程&nbsp;(19)</a>&nbsp;&nbsp;
	        
	        	<a href="GPU&&%E6%B8%B2%E6%9F%93.html">GPU&&渲染&nbsp;(3)</a>&nbsp;&nbsp;
	        
	        	<a href="%E6%9E%B6%E6%9E%84%E5%AD%A6%E4%B9%A0.html">架构学习&nbsp;(8)</a>&nbsp;&nbsp;
	        
	        	<a href="%E7%AC%AC%E4%B8%89%E6%96%B9%E9%A1%B9%E7%9B%AE%E5%AD%A6%E4%B9%A0.html">第三方项目学习&nbsp;(20)</a>&nbsp;&nbsp;
	        
	        	<a href="%E9%A1%B9%E7%9B%AE%E7%9B%91%E6%8E%A7.html">项目监控&nbsp;(10)</a>&nbsp;&nbsp;
	        
	        	<a href="%E6%B5%8B%E8%AF%95.html">调试&&测试&nbsp;(5)</a>&nbsp;&nbsp;
	        
	        	<a href="Cocoapods.html">Cocoapods&nbsp;(4)</a>&nbsp;&nbsp;
	        
	        	<a href="%E6%A8%A1%E5%9D%97%E5%8C%96%E7%9F%A5%E8%AF%86%E5%AD%A6%E4%B9%A0.html">模块化知识学习&nbsp;(26)</a>&nbsp;&nbsp;
	        
	        	<a href="Instrument%E5%AD%A6%E4%B9%A0.html">Instrument学习&nbsp;(1)</a>&nbsp;&nbsp;
	        
	        	<a href="%E7%9F%A5%E8%AF%86%E7%82%B9.html">知识点&nbsp;(10)</a>&nbsp;&nbsp;
	        
	        	<a href="%E8%A1%A5%E5%85%85-1.html">补充&nbsp;(9)</a>&nbsp;&nbsp;
	        
	        	<a href="%E9%9D%A2%E8%AF%95.html">面试&nbsp;(8)</a>&nbsp;&nbsp;
	        
	         </p> 
	      </li>
	  
	      <li class="post">
	        <a href="Swift.html"><strong>Swift初学笔记&nbsp;(28)</strong></a>
	         <p class="cat-children-p"> 
	        
	        	<a href="Swift-BaseLearning.html">Swift基础知识&nbsp;(28)</a>&nbsp;&nbsp;
	        
	         </p> 
	      </li>
	  
	      <li class="post">
	        <a href="Computer-programming.html"><strong>计算机编程&nbsp;(2)</strong></a>
	        
	        
	        
	      </li>
	  
	      <li class="post">
	        <a href="iOSDevelop.html"><strong>iOSDevelop&nbsp;(27)</strong></a>
	         <p class="cat-children-p"> 
	        
	        	<a href="iOS%20%E5%B0%8F%E7%9F%A5%E8%AF%86.html">iOS 小知识&nbsp;(14)</a>&nbsp;&nbsp;
	        
	        	<a href="iOS%E5%BC%80%E5%8F%91%E7%9F%A5%E8%AF%86.html">iOS开发知识&nbsp;(12)</a>&nbsp;&nbsp;
	        
	         </p> 
	      </li>
	  
	      <li class="post">
	        <a href="JavaScript%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html"><strong>JavaScript学习笔记&nbsp;(41)</strong></a>
	         <p class="cat-children-p"> 
	        
	        	<a href="%E5%9F%BA%E7%A1%80.html">基础&nbsp;(11)</a>&nbsp;&nbsp;
	        
	        	<a href="%E7%9F%A5%E8%AF%86%E6%99%AE%E5%8F%8A.html">知识普及&nbsp;(1)</a>&nbsp;&nbsp;
	        
	        	<a href="Flex.html">Flex&nbsp;(2)</a>&nbsp;&nbsp;
	        
	        	<a href="ES6.html">ES6&nbsp;(17)</a>&nbsp;&nbsp;
	        
	        	<a href="React.html">React&nbsp;(10)</a>&nbsp;&nbsp;
	        
	         </p> 
	      </li>
	  
	      <li class="post">
	        <a href="React-Native.html"><strong>React-Native&nbsp;(6)</strong></a>
	        
	        
	        
	      </li>
	  
	      <li class="post">
	        <a href="Python.html"><strong>Python&nbsp;(14)</strong></a>
	        
	        
	        
	      </li>
	  
	      <li class="post">
	        <a href="%E7%AE%97%E6%B3%95%E5%AD%A6%E4%B9%A0.html"><strong>算法学习&nbsp;(2)</strong></a>
	         <p class="cat-children-p"> 
	        
	        	<a href="%E7%AE%97%E6%B3%95%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0.html">算法读书笔记&nbsp;(2)</a>&nbsp;&nbsp;
	        
	         </p> 
	      </li>
	   
	  </ul>
	</section>
	<section>
	  <h1>Recent Posts</h1>
	  <ul id="recent_posts">
	  
	      
		      <li class="post">
		        <a href="15680194937623.html">AFSecurityPolicy</a>
		      </li>
	     
	  
	      
		      <li class="post">
		        <a href="15680125238227.html">AFNetworkReachabilityManager</a>
		      </li>
	     
	  
	      
		      <li class="post">
		        <a href="15677400518331.html">AFURLSerialization</a>
		      </li>
	     
	  
	      
		      <li class="post">
		        <a href="15676621460215.html">AFURLSessionManager</a>
		      </li>
	     
	  
	      
		      <li class="post">
		        <a href="15675682575589.html">AFNetworking</a>
		      </li>
	     
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	   
	  </ul>
	</section>
	
</aside> </div></div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 -  -
  <span class="credit">Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a> &nbsp;&nbsp; Theme by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>

  
    




</body>
</html>