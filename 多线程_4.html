<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
    
  多线程 - ACEfish-Blog
  
  </title>
  
  
  <link href="atom.xml" rel="alternate" title="ACEfish-Blog" type="application/atom+xml">
    <link rel="stylesheet" href="asset/css/foundation.min.css" />
    <link rel="stylesheet" href="asset/css/docs.css" />
    <script src="asset/js/vendor/modernizr.js"></script>
    <script src="asset/js/vendor/jquery.js"></script>
  <script src="asset/highlightjs/highlight.pack.js"></script>
  <link href="asset/highlightjs/styles/github.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script>hljs.initHighlightingOnLoad();</script>
<script type="text/javascript">
  function before_search(){
    var searchVal = 'site:acefish.github.io ' + document.getElementById('search_input').value;
    document.getElementById('search_q').value = searchVal;
    return true;
  }
</script>
  </head>
  <body class="antialiased hide-extras">
    
    <div class="marketing off-canvas-wrap" data-offcanvas>
      <div class="inner-wrap">


<nav class="top-bar docs-bar hide-for-small" data-topbar>


  <section class="top-bar-section">
  <div class="row">
      <div style="position: relative;width:100%;"><div style="position: absolute; width:100%;">
        <ul id="main-menu" class="left">
        
        <li id=""><a target="_self" href="index.html">Home</a></li>
        
        <li id=""><a target="_self" href="archives.html">Archives</a></li>
        
        </ul>

        <ul class="right" id="search-wrap">
          <li>
<form target="_blank" onsubmit="return before_search();" action="http://google.com/search" method="get">
    <input type="hidden" id="search_q" name="q" value="" />
    <input tabindex="1" type="search" id="search_input"  placeholder="Search"/>
</form>
</li>
          </ul>
      </div></div>
  </div>
  </section>

</nav>

        <nav class="tab-bar show-for-small">
  <a href="javascript:void(0)" class="left-off-canvas-toggle menu-icon">
    <span> &nbsp; ACEfish-Blog</span>
  </a>
</nav>

<aside class="left-off-canvas-menu">
      <ul class="off-canvas-list">
        
        <li><a target="_self" href="index.html">Home</a></li>
        
        <li><a target="_self" href="archives.html">Archives</a></li>
        

    <li><label>Categories</label></li>

        
            <li><a href="iOS%20%E5%BC%80%E5%8F%91%E6%A8%A1%E5%9D%97%E7%9F%A5%E8%AF%86.html">iOS 开发模块知识</a></li>
        
            <li><a href="Swift.html">Swift初学笔记</a></li>
        
            <li><a href="Computer-programming.html">计算机编程</a></li>
        
            <li><a href="iOSDevelop.html">iOSDevelop</a></li>
        
            <li><a href="JavaScript%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html">JavaScript学习笔记</a></li>
        
            <li><a href="React-Native.html">React-Native</a></li>
        
            <li><a href="Python.html">Python</a></li>
         

      </ul>
    </aside>

<a class="exit-off-canvas" href="#"></a>


        <section id="main-content" role="main" class="scroll-container">
        
       

 <script type="text/javascript">
	$(function(){
		$('#menu_item_index').addClass('is_active');
	});
</script>
<div class="row">
	<div class="large-8 medium-8 columns">
		<div class="markdown-body home-categories">
		
			<div class="article">
                <a class="clearlink" href="15548649461552.html">
                
                  <h1>dispatch_block_t</h1>
                  <div class="a-content">
                      
                      <div class="a-content-text">
                        
                        	<h4 id="toc_0">dispatch_block_t</h4>

<p><code>typedef void (^dispatch_block_t)(void);</code></p>

<p>注意:<br/>
声明的block是分配在stack上的</p>

<pre><code class="language-objectivec">//下面写法是错误的
dispatch_block_t block;
if (x) {
block = ^{ printf(&quot;true\n&quot;); };
} else {
block = ^{ printf(&quot;false\n&quot;); };
}
block();
</code></pre>

<p>block是在栈上的，当<code>{}</code>退出时，block就无效了</p>

<h4 id="toc_1">dispatch_block_create_with_qos_class</h4>

<p>在堆上创建新的dispatch block，指定其执行block，分配指定的<code>QoS</code>类和相对优先级</p>

<pre><code class="language-objectivec">dispatch_block_t dispatch_block_create_with_qos_class(dispatch_block_flags_t flags, dispatch_qos_class_t qos_class, int relative_priority, dispatch_block_t block);
//flags 设置block的标记 必须为有效的位标记，否则返回NULL
//qos_class QoS类， 这个值传QOS_CLASS_UNSPECIFIED 相当于DISPATCH_BLOCK_NO_QOS_CLASSflag
//指定qos类的相对优先级 越大优先级越高 为负值 不能赋值给其大于0 小于QOS_MIN_RELATIVE_PRIORITY的值 否则会返回NULL
</code></pre>

<blockquote>
<p>提供的参数block会被copy到堆上，被新创建的dispatch block持有</p>

<p>这个block可以<code>dispatch_async</code>到queue中执行或者直接执行<br/>
block可以用这两种方式多次执行，但是只有第一次执行的block可以被<code>dispatch_block_wait</code>等待或者<code>dispatch_block_notify.</code>监听</p>

<p>直接执行时，如果分配的QoS类比调用的线程的QoS类优先级高，则使用分配的QoS类执行<br/>
如果dispatch block到queue中执行，则执行它的QoS类取决于分配给bloc的QoS，queue的QoS或者flags共同决定<br/>
如果block被直接提交到串行队列执行，则QoS类无效，系统会尽力覆盖QoS使先执行的block的QoS类等级更高，优先执行</p>
</blockquote>

<pre><code class="language-objectivec">//flag的类型
DISPATCH_ENUM(dispatch_block_flags, unsigned long,
    DISPATCH_BLOCK_BARRIER = 0x1,
    /**
    当在一个DISPATCH_QUEUE_CONCURRENT的queue中执行dispatch block时
    表明这个block是barrier，即使不使用dispatch_barrier_async函数也可以在起到栅栏作用
    在直接执行dispatch block时，这个flags无效
    */
    DISPATCH_BLOCK_DETACHED = 0x2,
    /**
    将dispatch block与当前执行的context(上下文)分离
    */
    DISPATCH_BLOCK_ASSIGN_CURRENT = 0x4,
    /**
    指定dispatch block使用当前执行的context
    */
    DISPATCH_BLOCK_NO_QOS_CLASS = 0x8,
    /**
    表示不为block分配QoS类
    直接执行block，则使用调用线程的QoS
    如果给该block分配了特定QoS类，则该flag设置无效，忽略
    */
    DISPATCH_BLOCK_INHERIT_QOS_CLASS = 0x10,
    /**
        Queue的QoS类优先于block的QoS类，只有当队列没有QoS时才会使用block的QoS
        在直接调用block时，该flags值无效
        将block提交到queue中异步执行时，该值为默认值
        当设置了DISPATCH_BLOCK_ENFORCE_QOS_CLASS时，该default flag被忽略
    */
    DISPATCH_BLOCK_ENFORCE_QOS_CLASS = 0x20,
    /**
        表示当block的QoS类优先级高于Queue的QoS类时，优先选择block的QoS类
        当直接执行block或者将block提交到Queue中进行同步执行时，此为默认值
    */
);
</code></pre>

<blockquote>
<p><code>DISPATCH_BLOCK_BARRIER</code>即在自己创建的并行队列中 做栅栏block</p>

<p><code>DISPATCH_BLOCK_DETACHED</code>、<code>DISPATCH_BLOCK_ASSIGN_CURRENT</code>、<code>DISPATCH_BLOCK_NO_QOS_CLASS</code>用于<code>dispatch_block_create</code>函数，而在<code>dispatch_block_create_with_qos_class</code>中指定了QoS类，该flag就失效了</p>
</blockquote>

<p><a href="https://developer.apple.com/library/archive/documentation/Performance/Conceptual/power_efficiency_guidelines_osx/RelatedDocuments.html#//apple_ref/doc/uid/TP40013929-CH20-SW16">Quality of Service Classes (QoS).</a></p>

<pre><code class="language-objectivec">__QOS_ENUM(qos_class, unsigned int,
    QOS_CLASS_USER_INTERACTIVE = 0x21,
        /**
          表示任务需要被立即执行 响应事件更新UI 用来处理主事件循环、视图绘制、动画等
        */
    QOS_CLASS_USER_INITIATED = 0x19,
        /**
          表示任务由UI发起异步任务。等待结果
        */
    QOS_CLASS_DEFAULT = 0x15,
        /**
          默认优先级
        */
    QOS_CLASS_UTILITY = 0x11,
        /**
          表示需要长时间运行任务，伴有进度指示器；用来做计算、I/O,网络，持续数据填充等
        */
    QOS_CLASS_BACKGROUND = 0x09,
        /**
          表示用户不需要察觉的任务，用来预处理加载
        */
    QOS_CLASS_UNSPECIFIED = 0x00,
        /**
          未指明
        */
);
</code></pre>

<h4 id="toc_2">dispatch_block_create</h4>

<pre><code class="language-objectivec">dispatch_block_t dispatch_block_create(dispatch_block_flags_t flags, dispatch_block_t block);
//flags 设置block的标记 必须为有效的位标记，否则返回NULL 与上面的flag相同
//block设置具体任务 block将会copy到新的dispatch block中
</code></pre>

<blockquote>
<p>当返回的dispath block被提交到queue中执行时，block与当前提交时的QoS类相关联，除非有以下flags在创建block时指定了QoS类(或者不指定QoS类):<br/>
<code>DISPATCH_BLOCK_ASSIGN_CURRENT</code><br/>
<code>DISPATCH_BLOCK_NO_QOS_CLASS</code><br/>
<code>DISPATCH_BLOCK_DETACHED</code></p>

<p>当dispatch block在queue中执行时，则执行它的QoS类取决于分配给bloc的QoS，queue的QoS或者flags共同决定:<br/>
<code>DISPATCH_BLOCK_INHERIT_QOS_CLASS</code>(异步执行默认值)<br/>
<code>DISPATCH_BLOCK_INHERIT_QOS_CLASS</code>(同步执行默认值)</p>
</blockquote>

<h2 id="toc_3">dispatch_block_perform</h2>

<pre><code class="language-objectivec">void dispatch_block_perform(dispatch_block_flags_t flags, dispatch_block_t block);
</code></pre>

<p>通过指定<code>flag</code>和block，<strong>同步</strong>执行该block，并且release生成的dispatchBlock</p>

<p>这个函数相当于下面这段代码:<br/>
并且与下面这段代码相比，不需要将block copy到堆上开辟新的内存，在内部更高效的实现</p>

<pre><code class="language-objectivec">dispatch_block_t b = dispatch_block_create(flags, block);
b();
Block_release(b);
</code></pre>

<h2 id="toc_4">dispatch_block_wait</h2>

<p><strong>同步</strong>等待dispatch Block执行完成 或者 超时<br/>
会阻塞当前线程 </p>

<pre><code class="language-obj">long dispatch_block_wait(dispatch_block_t block, dispatch_time_t timeout);
//block: 应该为dispatch_block_create 或者dispatch_block_create_with_qos_class 创建的block
//超时时间:  
//返回值: 如果执行block时间小于超时时间返回0，否则返回非0
</code></pre>

<p><strong>同一个block只会被等待一次，执行多次，也只能同时被一个等待</strong></p>

<blockquote>
<ol>
<li>dispatch_block_wait 只会监听第一个block执行情况，如果已经执行过一次了，这个函数就会立即返回</li>
<li>请使用<code>dispatch_group_wait</code>监听统一block的多次执行</li>
<li>不能在多线程中同时执行该函数等待同一个block返回，因为block只能等待一次</li>
<li>如果该函数返回超时，则这次等待不算，即还可以再次等待block完成，否则只能等待一次</li>
<li>提交到queue执行block即使立即用<code>dispatch_block_cancel</code>使其不执行，这也算执行过一次了</li>
</ol>
</blockquote>

<h2 id="toc_5">dispatch_block_notify</h2>

<p>监听block执行完成，将要执行的block放入queue指定queue中执行</p>

<pre><code class="language-objectivec">void dispatch_block_notify(dispatch_block_t block, dispatch_queue_t queue, dispatch_block_t notification_block);
//block: 监听的block  应该为dispatch_block_create 或者dispatch_block_create_with_qos_class 创建的block
//queue
//notification_block: 当监听的block执行完成 执行的block
</code></pre>

<blockquote>
<ol>
<li>当监听的block已经完成 该监听block会立即执行</li>
<li>无法监听相同block的多次执行的，请使用<code>dispatch_group_notify</code></li>
<li><strong>block可以执行一次 监听多次</strong></li>
<li>如果多个监听统一block执行，不能预期监听的block执行顺序</li>
<li>提交到queue执行block即使立即用<code>dispatch_block_cancel</code>使其不执行，这也算执行过一次了</li>
</ol>
</blockquote>

<h2 id="toc_6">dispatch_block_cancel</h2>

<p>异步取消指定<code>dispatch block</code></p>

<pre><code class="language-objectivec">void dispatch_block_cancel(dispatch_block_t block);
//block： 应该使用dispatch_block_create 或者dispatch_block_create_with_qos_class 创建的block
</code></pre>

<p>对于所有未执行的block去 立即返回并不执行，但是对于那些已经在执行的 则没有影响</p>

<p>注意: 确保可能被取消的block不持有任何需要执行block才会释放的资源，例如malloc内存，否则由于永远不执行block块导致内存泄漏</p>

<blockquote>
<p>已经被cancel的block无法再执行</p>
</blockquote>

<h4 id="toc_7">dispatch_block_testcancel</h4>

<p>测试是否这个block已经被取消</p>

<pre><code class="language-objectivec">long dispatch_block_testcancel(dispatch_block_t block);
//返回: 被取消的话返回非0，否则返回0
</code></pre>

                        
                      </div>
                  </div>
                </a>
                <div class="read-more clearfix">
                  <div class="more-left left">
                  
                    <span class="date">2019/4/10</span>
                    <span>posted in&nbsp;</span> 
          				  
          					    <span class="posted-in"><a href='%E5%A4%9A%E7%BA%BF%E7%A8%8B.html'>多线程</a></span>
          				   
                  </div>
                  <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                  </div>
                </div>
              </div><!-- article -->
        
              


			<div class="row">
			  <div class="large-6 columns">
			  <p class="text-left" style="padding-top:25px;">
			   <a href="多线程_3.html">&laquo; Prev Page</a>  
			  </p>
			  </div>
			  <div class="large-6 columns">
			<p class="text-right" style="padding-top:25px;">
			 <a href="多线程_5.html">&raquo; Next Page</a> 
			</p>
			  </div>
			</div>
		</div>
	</div><!-- large 8 -->

 <div class="large-4 medium-4 columns">
  <div class="hide-for-small">
    <div id="sidebar" class="sidebar">
          <div id="site-info" class="site-info">
            
                <h1>ACEfish-Blog</h1>
                <div class="site-des"></div>
                <div class="social">









<a target="_blank" class="github" target="_blank" href="https://github.com/ACEfish/ACEfish.github.io" title="GitHub">GitHub</a>

  <a target="_blank" class="rss" href="atom.xml" title="RSS">RSS</a>
                
              	 </div>
          	</div>

             

              <div id="site-categories" class="side-item ">
                <div class="side-header">
                  <h2>Categories</h2>
                </div>
                <div class="side-content">

      	<p class="cat-list">
        
            <a href="iOS%20%E5%BC%80%E5%8F%91%E6%A8%A1%E5%9D%97%E7%9F%A5%E8%AF%86.html"><strong>iOS 开发模块知识</strong></a>
        
            <a href="Swift.html"><strong>Swift初学笔记</strong></a>
        
            <a href="Computer-programming.html"><strong>计算机编程</strong></a>
        
            <a href="iOSDevelop.html"><strong>iOSDevelop</strong></a>
        
            <a href="JavaScript%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html"><strong>JavaScript学习笔记</strong></a>
        
            <a href="React-Native.html"><strong>React-Native</strong></a>
        
            <a href="Python.html"><strong>Python</strong></a>
         
        </p>


                </div>
              </div>

              <div id="site-categories" class="side-item">
                <div class="side-header">
                  <h2>Recent Posts</h2>
                </div>
                <div class="side-content">
                <ul class="posts-list">
	      
		      
			      <li class="post">
			        <a href="15556625620569.html">pod repo update</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="15556594680013.html"></a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="15554889031358.html">otool命令</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="15554886689884.html">Mach文件</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="15553854847636.html">运行时</a>
			      </li>
		     
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		   
		  		</ul>
                </div>
              </div>
        </div><!-- sidebar -->
      </div><!-- hide for small -->
</div><!-- large 4 -->

</div><!-- row -->

 <div class="page-bottom clearfix">
  <div class="row">
   <p class="copyright">Copyright &copy; 2015
Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a>,&nbsp; 
Theme used <a target="_blank" href="http://github.com">GitHub CSS</a>.</p>
  </div>
</div>

        </section>
      </div>
    </div>

  
    

    <script src="asset/js/foundation.min.js"></script>
    <script>
      $(document).foundation();
      function fixSidebarHeight(){
        var w1 = $('.markdown-body').height();
          var w2 = $('#sidebar').height();
          if (w1 > w2) { $('#sidebar').height(w1); };
      }
      $(function(){
        fixSidebarHeight();
      })
      $(window).load(function(){
          fixSidebarHeight();
      });
     
    </script>

    



  </body>
</html>
