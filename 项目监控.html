
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>
    
  项目监控 - ACEfish-Blog
  

  </title>
  <meta name="author" content="">
  <meta name="description" content="学习记录">

  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link href="asset/css/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="atom.xml" rel="alternate" title="ACEfish-Blog" type="application/atom+xml">
  <script src="asset/js/modernizr-2.0.js"></script>
  <script src="asset/js/jquery.min.js"></script>
  <script src="asset/highlightjs/highlight.pack.js"></script>
  <link href="asset/highlightjs/styles/solarized_light.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script>hljs.initHighlightingOnLoad();</script>

  <style type="text/css">
  .cat-children-p{ padding: 6px 0px;}
  .hljs{background: none;}
  </style>
  <script type="text/javascript">
  var isAddSildbar = true;
  </script>
  <script src="asset/js/octopress.js" type="text/javascript"></script>
</head>
<script type="text/javascript">
//链接新开窗口
function addBlankTargetForLinks () {
  $('a[href^="http"]').each(function(){
      $(this).attr('target', '_blank');
  });
}
$(document).ready(function(event) {
  addBlankTargetForLinks();
});
</script>
<body   >
  <header role="banner"><hgroup>
  <h1><a href="index.html">ACEfish-Blog</a></h1>
  
    <h2>学习记录</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:acefish.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">

  <li id=""><a target="_self" href="index.html">首页</a></li>

  <li id=""><a target="_self" href="archives.html">归档</a></li>

</ul>

</nav>
  <div id="main">
    <div id="content"> 
<div class="blog-index">

	<article>
		 <header>
		  	<h1 class="entry-title"><a href="15645609012102.html">包大小</a></h1>
			<p class="meta"><time datetime="2019-07-31T16:15:01+08:00" 
			pubdate data-updated="true">2019/7/31</time></p>
		 </header>
	  	<div class="entry-content">
		  	
		  	<p>学习自 <a href="https://time.geekbang.org/column/article/88573">iOS开发高手课-包大小：如何从资源和代码层面实现全方位瘦身？</a></p>

<p>APPStore对大于150M的应用无法再OTA环境下载，这就只能在wifi环境下下载，因此150M就是App的生死线</p>

<p>如果App要兼容iOS7和iOS8的话，苹果规定主二进制 text 段的大小不能超过 60MB，如果没有达到这个标准，甚至无法提交AppStore</p>

<h2 id="toc_0">App Thinning</h2>

<p><code>App Thinning</code>是苹果公司推出的一项可以改善APP下载进程的新技术，主要为解决用户下载APP耗费流量过高，并节省用户iOS设备存储空间</p>

<p>因为iOS设备的屏幕尺寸和分辨率 越来越多样化，就需要更多资源来匹配不同尺寸和分辨率。同时，App也会有32位、64位不同芯片架构的优化版本。如果这些都在同一个包中，那么用户下载包的大小势必就会变得更大</p>

<p>而苹果提供的<code>App Thinning</code>就是针对不同的设备只选择适合当前设备的内容进行下载。比如，iPhone6只下载2x资源，而iPhone6 P则只下载3x图片资源</p>

<p>在之前，每个app包会包含多个芯片的指令集架构文件。在而使用<code>App Thinning</code>后，用户下载时就只会下载一个适合自己设备的芯片指令集架构文件</p>

<p>下图为所有设备的芯片指令集以及支持的最高和最低版本<br/>
<img src="media/15645609012102/15645634237337.png" alt=""/></p>

<p><strong><code>App Thinning</code>有三种方式，包括： App Slicing、Bitcode、On-Demand Resource</strong></p>

<ul>
<li>App Slicing：会在你向iTunnes Connrct上传App后，对App做切个，创建不同的变体，来适应不同的设备</li>
<li>On-Demand Resource，主要是为游戏多关卡场景服务。可以根据用户的关卡进度下载随后关卡资源，并且删除已过关的资源，来减少出装app的大小</li>
<li>Bitcode， 针对特定设备进行包大小优化，优化并不明显</li>
</ul>

<h3 id="toc_1">App Thinning的使用</h3>

<p>使用App Thinning很简单，只需要通过Xcode添加 xcassets目录，然后将资源文件放进来即可：</p>

<p>即添加<code>Asset Catalog</code>模板，按照模板添加资源即可，apple会创建不同的变体来减少app安装体积</p>

<h2 id="toc_2">图片资源优化</h2>

<p>图片资源的优化空间主要体现在删除无用图片和图片资源压缩两方面。</p>

<h3 id="toc_3">查找无用图片资源</h3>

<ol>
<li>通过find获取App安装包中所有资源文件 </li>
<li>设置用到的资源类型，比如jpg、gif、png、webp</li>
<li>使用正则表达式匹配在源码中找出使用到的资源名，比如<code>pattern=@&quot;@&quot;(.+?)&quot;&quot;</code></li>
<li>使用find命令找到所有资源文件，再去掉代码中使用到的资源文件，剩下的就是未使用到的了</li>
<li>对于按照规则设置的资源名字，我们需要在匹配使用资源的正则表达式里，添加响应的规则，比如<code>image_%d</code></li>
<li>确认无用资源后，就可以对无用资源执行删除操作了，这个删除操作可以使用<code>NSFileManager</code>系统类功能完成</li>
</ol>

<p>可以使用一些开源的工具，推荐的为<a href="https://github.com/tinymind/LSUnusedResources">LSUnusedResources</a>,其还可以对使用编号规则的图片，直接添加规则处理</p>

<p><img src="media/15645609012102/15645678390885.gif" alt="" style="width:500px;"/></p>

<h3 id="toc_4">图片资源压缩</h3>

<p>在App中 图片资源总是占大头的。因此我们最好在不损失图片质量的前提下，尽可能的压缩。目前最好的压缩方案就是，将图片转为<a href="https://developers.google.com/speed/webp/">webP</a>(其是谷歌的一个开源项目)。</p>

<ul>
<li>WebP压缩率高，而且肉眼看不出来差异，同时支持有损和无损两种压缩模式。比如，将Gif专务Anumated WebP，有损模式下会减少64%大小，无损模式下会减少19%大小</li>
<li>WebP支持Alpha透明和24-bit颜色数，不会像PNG8那样因为颜色不够而出现毛边</li>
</ul>

<h4 id="toc_5">将图片转为webP</h4>

<p>Google提供了<code>cwebp</code>工具来将其它图片转成WebP。cwebp只需根据图片情况设置相应参数即可：</p>

<pre><code class="language-text">cwebp [options] input_file -o output_file.webp

//比如无损压缩文件命令如下   -lossless表示无损压缩
cwebp -lossless original.png -o new.webp
</code></pre>

<p>注意：<br/>
在图片色值不同的情况下，可以选择用-q参数进行设置，在不损失图片质量情况下进行最大化压缩：</p>

<ul>
<li>小于256色适合无损压缩，压缩率高，参数使用-lossless -q 100</li>
<li>大于256色适合用75%的有损压缩，参数使用-q 75</li>
<li>远大于256色 适合使用75%一下的压缩率，参数-q 50 -m 6</li>
</ul>

<p>除了使用google提供的cwebp工具外，可以使用企鹅公司开发的<a href="http://isparta.github.io/">iSparta</a>图形化工具，实现PNG到WebP转换，还可以批量处理和记录操作配置。至于其他格式图片，那就先转png再转webP即可</p>

<h4 id="toc_6">显示WebP图片</h4>

<p>在图片压缩完成后，还需要在项目中显示图片，使用<code>libwebp</code>进行解析。可以参考<a href="https://github.com/carsonmcdonald/WebP-iOS-example">这个iOS项目范例</a></p>

<p>当然，因为WebP进行了压缩，因此在CPU消耗和解码时间上是会比PNG大两倍。所以，需要在性能和体积上做出取舍</p>

<p><strong>建议： 如果图片大小超过100K，考虑使用WebP；小于100K时，可以使用网页工具<a href="https://tinypng.com/">TinyPng</a>或者图形化工具<a href="https://imageoptim.com/mac">ImageOptim</a>进行图片压缩。这两种工具的压缩率没有WebP高，不会改变图片压缩方式，相应的解析式对性能损耗也不会增加</strong></p>

<h2 id="toc_7">代码瘦身</h2>

<p>App的安装包之中主要就是资源文件和可执行文件，而我们在掌握了对图片资源的优化之后，就需要学习怎么优化可执行文件了</p>

<p>可执行文件就是一个<code>Mach-O</code>文件了，大小由其代码量决定。通常，<strong>对可执行文件瘦身就是，删除无用代码的过程</strong></p>

<ul>
<li>首先，找出方法和类的全集</li>
<li>然后，找到使用过的方法和类</li>
<li>接下来，取二者的差集即为无用代码</li>
<li>最后人工确认进行删除</li>
</ul>

<h3 id="toc_8">LinkMap 结合 Mach-O找到无用代码</h3>

<h4 id="toc_9">LinkMap 来获得所有的代码类和方法的信息</h4>

<p>通过在build setting中打开<code>Write Link Map</code>然后指定其path 可以获得编译后的LinkMapp文件，其主要分为 <code>Object File</code>、<code>Section</code>、<code>Symbols</code></p>

<ul>
<li>Object File：主要包含了代码工程的所有文件</li>
<li>Section：描述代码段在生成的Mach-O里的偏移位置和大小</li>
<li>Symbols会列出每个方法、类、block、以及它们的大小</li>
</ul>

<h4 id="toc_10">通过Mach-O获取所有使用过的方法和类</h4>

<p>iOS方法都是通过<code>objc_send</code>方法调用的。而，objc_msgSend在Mach-O文件中是通过<code>__objc_selrefs</code>这个section来获取selector这个参数的</p>

<p>因此: <strong>__Objc_selrefs里是调用过的方法。_objc_classrefs里是调用过的类，_objc_superrefs里是调用过super的类。因此，通过_objc_classrefs和_objc_superrefs就可以获取所有使用过的类和子类</strong></p>

<p>想要查看Mach-O文件中的信息 我们可以通过<a href="https://sourceforge.net/projects/machoview/">MachOView这个软件</a>查看文件中的信息，其<a href="https://github.com/gdbinit/MachOView">源码地址</a></p>

<p><img src="media/15645609012102/15646435135341.jpg" alt="" style="width:690px;"/></p>

<p>因为可能存在运行时调用，所以这种方法并不完美，需要做二次确认，而且人工量太大，不适合频繁检测</p>

<h3 id="toc_11">AppCode找出无用代码</h3>

<p>AppCode当代码量过百万时，就无法做静态分析了。但是当项目工程量不大时，是可以直接用<code>AppCode</code>来做静态分析的。毕竟当代码量达到百万行级别的团队，是会自己通过Clang静态分析来开发工具，检查无用的方法和类</p>

<p>使用很简单 在AppCode中选择Code-&gt;Inspect Code就可以进行静态分析<br/>
静态分析之后，可以再Ununsed Code中看到所有的无用代码<br/>
<img src="media/15645609012102/15646441469049.jpg" alt="" style="width:538px;"/></p>

<p>其中包括了</p>

<ul>
<li>无用类：Unused class 无用类，Unused import statement 无用类引用声明， Unused property 无用的属性</li>
<li>无用方法：Unused method 无用的方法 Unused parameter 无用参数 Unused instance variable无用的实例变量 Unused local variable无用的局部变量 Unused value 无用值</li>
<li>无用宏： Unused macro 无用的宏</li>
<li>无用全局： Unused global declation 是无用的全局声明</li>
</ul>

<p>注意，AppCode检查存在的问题:</p>

<ul>
<li>JSONModel里定义了未使用的协议会被判定为无用协议</li>
<li>子类使用了父类的方法，那这个服类方法并不会任务被使用了</li>
<li>通过点方式使用的属性，该属性会被认为没有使用</li>
<li>使用performSelector方法调用的方法，是检查不出的</li>
<li>运行时声明类的情况检查不出来</li>
</ul>

<p>因此，Appcode检查的无用代码也请 人工二次确认之后才能安全删除</p>

<h3 id="toc_12">运行时检查类是否真的被使用</h3>

<p>通过ObjC的runtime源码，我们可以找到怎么判断一个类是否初始化过的函数:</p>

<pre><code class="language-objectivec">#define RW_INITIALIZED (1&lt;&lt;29)
bool isInitialized() {
   return getMeta()-&gt;data()-&gt;flags &amp; RW_INITIALIZED;
}
</code></pre>

<p><code>isInitialized</code>的结果会保存到元类的class_rw_t结构体的flags信息里，flags的1&lt;&lt;29位记录的就是这个类是否初始化的信息。而flags的其他位记录的信息</p>

<pre><code class="language-objectivec">// 类的方法列表已修复
#define RW_METHODIZED         (1&lt;&lt;30)

// 类已经初始化了
#define RW_INITIALIZED        (1&lt;&lt;29)

// 类在初始化过程中
#define RW_INITIALIZING       (1&lt;&lt;28)

// class_rw_t-&gt;ro 是 class_ro_t 的堆副本
#define RW_COPIED_RO          (1&lt;&lt;27)

// 类分配了内存，但没有注册
#define RW_CONSTRUCTING       (1&lt;&lt;26)

// 类分配了内存也注册了
#define RW_CONSTRUCTED        (1&lt;&lt;25)

// GC：class 有不安全的 finalize 方法
#define RW_FINALIZE_ON_MAIN_THREAD (1&lt;&lt;24)

// 类的 +load 被调用了
#define RW_LOADED             (1&lt;&lt;23)
</code></pre>

<p>这样就能够找出哪些类是没有初始化的，找到真实环境中没有用到的类并清理。具体实施时，可以线下测试检查所有类，测出那些类没有使用，然后上线针对没有用到的类进行多版本检测，判断合理性后二次确认，并且最终将真正没有用到的类进行删除</p>


		</div>

		

	</article>
  
	<div class="pagination">
	 <a class="prev" href="项目监控_1.html">&larr; Older</a> 
<a href="archives.html">Blog Archives</a>
	 
	    
	</div>
</div>
 <aside class="sidebar"> 

	<section>
	  <h1>Categories</h1>
	  <ul id="recent_posts">
	  
	      <li class="post">
	        <a href="iOS%20%E5%BC%80%E5%8F%91%E6%A8%A1%E5%9D%97%E7%9F%A5%E8%AF%86.html"><strong>iOS 开发模块知识&nbsp;(172)</strong></a>
	         <p class="cat-children-p"> 
	        
	        	<a href="iOS%E7%BC%96%E8%AF%91.html">iOS编译&nbsp;(20)</a>&nbsp;&nbsp;
	        
	        	<a href="%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86&Block.html">内存管理&Block&nbsp;(18)</a>&nbsp;&nbsp;
	        
	        	<a href="RunTime.html">runtime&nbsp;(11)</a>&nbsp;&nbsp;
	        
	        	<a href="Concurrent-Programming.html">多线程&nbsp;(19)</a>&nbsp;&nbsp;
	        
	        	<a href="GPU&&%E6%B8%B2%E6%9F%93.html">GPU&&渲染&nbsp;(3)</a>&nbsp;&nbsp;
	        
	        	<a href="%E6%9E%B6%E6%9E%84%E5%AD%A6%E4%B9%A0.html">架构学习&nbsp;(8)</a>&nbsp;&nbsp;
	        
	        	<a href="%E7%AC%AC%E4%B8%89%E6%96%B9%E9%A1%B9%E7%9B%AE%E5%AD%A6%E4%B9%A0.html">第三方项目学习&nbsp;(20)</a>&nbsp;&nbsp;
	        
	        	<a href="%E9%A1%B9%E7%9B%AE%E7%9B%91%E6%8E%A7.html">项目监控&nbsp;(10)</a>&nbsp;&nbsp;
	        
	        	<a href="%E6%B5%8B%E8%AF%95.html">调试&&测试&nbsp;(5)</a>&nbsp;&nbsp;
	        
	        	<a href="Cocoapods.html">Cocoapods&nbsp;(4)</a>&nbsp;&nbsp;
	        
	        	<a href="%E6%A8%A1%E5%9D%97%E5%8C%96%E7%9F%A5%E8%AF%86%E5%AD%A6%E4%B9%A0.html">模块化知识学习&nbsp;(26)</a>&nbsp;&nbsp;
	        
	        	<a href="Instrument%E5%AD%A6%E4%B9%A0.html">Instrument学习&nbsp;(1)</a>&nbsp;&nbsp;
	        
	        	<a href="%E7%9F%A5%E8%AF%86%E7%82%B9.html">知识点&nbsp;(10)</a>&nbsp;&nbsp;
	        
	        	<a href="%E8%A1%A5%E5%85%85-1.html">补充&nbsp;(9)</a>&nbsp;&nbsp;
	        
	        	<a href="%E9%9D%A2%E8%AF%95.html">面试&nbsp;(8)</a>&nbsp;&nbsp;
	        
	         </p> 
	      </li>
	  
	      <li class="post">
	        <a href="Swift.html"><strong>Swift初学笔记&nbsp;(28)</strong></a>
	         <p class="cat-children-p"> 
	        
	        	<a href="Swift-BaseLearning.html">Swift基础知识&nbsp;(28)</a>&nbsp;&nbsp;
	        
	         </p> 
	      </li>
	  
	      <li class="post">
	        <a href="Computer-programming.html"><strong>计算机编程&nbsp;(2)</strong></a>
	        
	        
	        
	      </li>
	  
	      <li class="post">
	        <a href="iOSDevelop.html"><strong>iOSDevelop&nbsp;(27)</strong></a>
	         <p class="cat-children-p"> 
	        
	        	<a href="iOS%20%E5%B0%8F%E7%9F%A5%E8%AF%86.html">iOS 小知识&nbsp;(14)</a>&nbsp;&nbsp;
	        
	        	<a href="iOS%E5%BC%80%E5%8F%91%E7%9F%A5%E8%AF%86.html">iOS开发知识&nbsp;(12)</a>&nbsp;&nbsp;
	        
	         </p> 
	      </li>
	  
	      <li class="post">
	        <a href="JavaScript%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html"><strong>JavaScript学习笔记&nbsp;(41)</strong></a>
	         <p class="cat-children-p"> 
	        
	        	<a href="%E5%9F%BA%E7%A1%80.html">基础&nbsp;(11)</a>&nbsp;&nbsp;
	        
	        	<a href="%E7%9F%A5%E8%AF%86%E6%99%AE%E5%8F%8A.html">知识普及&nbsp;(1)</a>&nbsp;&nbsp;
	        
	        	<a href="Flex.html">Flex&nbsp;(2)</a>&nbsp;&nbsp;
	        
	        	<a href="ES6.html">ES6&nbsp;(17)</a>&nbsp;&nbsp;
	        
	        	<a href="React.html">React&nbsp;(10)</a>&nbsp;&nbsp;
	        
	         </p> 
	      </li>
	  
	      <li class="post">
	        <a href="React-Native.html"><strong>React-Native&nbsp;(6)</strong></a>
	        
	        
	        
	      </li>
	  
	      <li class="post">
	        <a href="Python.html"><strong>Python&nbsp;(14)</strong></a>
	        
	        
	        
	      </li>
	  
	      <li class="post">
	        <a href="%E7%AE%97%E6%B3%95%E5%AD%A6%E4%B9%A0.html"><strong>算法学习&nbsp;(2)</strong></a>
	         <p class="cat-children-p"> 
	        
	        	<a href="%E7%AE%97%E6%B3%95%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0.html">算法读书笔记&nbsp;(2)</a>&nbsp;&nbsp;
	        
	         </p> 
	      </li>
	   
	  </ul>
	</section>
	<section>
	  <h1>Recent Posts</h1>
	  <ul id="recent_posts">
	  
	      
		      <li class="post">
		        <a href="15680194937623.html">AFSecurityPolicy</a>
		      </li>
	     
	  
	      
		      <li class="post">
		        <a href="15680125238227.html">AFNetworkReachabilityManager</a>
		      </li>
	     
	  
	      
		      <li class="post">
		        <a href="15677400518331.html">AFURLSerialization</a>
		      </li>
	     
	  
	      
		      <li class="post">
		        <a href="15676621460215.html">AFURLSessionManager</a>
		      </li>
	     
	  
	      
		      <li class="post">
		        <a href="15675682575589.html">AFNetworking</a>
		      </li>
	     
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	   
	  </ul>
	</section>
	
</aside> </div></div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 -  -
  <span class="credit">Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a> &nbsp;&nbsp; Theme by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>

  
    




</body>
</html>