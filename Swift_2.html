
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>
    
  Swift初学笔记 - ACEfish-Blog
  

  </title>
  <meta name="author" content="">
  <meta name="description" content="学习记录">

  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link href="asset/css/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="atom.xml" rel="alternate" title="ACEfish-Blog" type="application/atom+xml">
  <script src="asset/js/modernizr-2.0.js"></script>
  <script src="asset/js/jquery.min.js"></script>
  <script src="asset/highlightjs/highlight.pack.js"></script>
  <link href="asset/highlightjs/styles/solarized_light.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script>hljs.initHighlightingOnLoad();</script>

  <style type="text/css">
  .cat-children-p{ padding: 6px 0px;}
  .hljs{background: none;}
  </style>
  <script type="text/javascript">
  var isAddSildbar = true;
  </script>
  <script src="asset/js/octopress.js" type="text/javascript"></script>
</head>
<script type="text/javascript">
//链接新开窗口
function addBlankTargetForLinks () {
  $('a[href^="http"]').each(function(){
      $(this).attr('target', '_blank');
  });
}
$(document).ready(function(event) {
  addBlankTargetForLinks();
});
</script>
<body   >
  <header role="banner"><hgroup>
  <h1><a href="index.html">ACEfish-Blog</a></h1>
  
    <h2>学习记录</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:acefish.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">

  <li id=""><a target="_self" href="index.html">首页</a></li>

  <li id=""><a target="_self" href="archives.html">归档</a></li>

</ul>

</nav>
  <div id="main">
    <div id="content"> 
<div class="blog-index">

	<article>
		 <header>
		  	<h1 class="entry-title"><a href="15660380397380.html">内存安全</a></h1>
			<p class="meta"><time datetime="2019-08-17T18:33:59+08:00" 
			pubdate data-updated="true">2019/8/17</time></p>
		 </header>
	  	<div class="entry-content">
		  	
		  	<p>默认情况下，<code>Swift</code>会阻止代码里的不安全行为。例如，变量在使用前完成初始化，在内存回收后无法被访问，并且数组的索引会做越界检查。</p>

<p>因为<code>Swift</code>管理内存，大部分时间 并不需要考虑内存访问的事情。然而，理解潜在冲突也是很重要的，可以避免写出访问冲突的代码。如果代码确实存在冲突，那在编译时或者运行时会得到错误。</p>

<h2 id="toc_0">理解内存访问冲突</h2>

<p>内存的访问，会发生在你给变量赋值，或者传递参数给函数时。<br/>
而内存的访问冲突发生在代码多个访问同时访问同一个内存地址，造成的不可预计或者不一致的行为。</p>

<h2 id="toc_1">内存访问性质</h2>

<p>内存访问冲突会发生在以下两个访问符合情况时:</p>

<ul>
<li>至少有一个是写访问</li>
<li>访问的是统一存储地址</li>
<li>访问在时间线上部分重叠</li>
</ul>

<p>内存的访问时长，要么是瞬时的，要么是长期的。主要区别在于，别的代码有没有可能在访问期间同时访问，也就是时间线上的重叠。一个长期访问可以被别的长期或者瞬时访问重叠</p>

<p>重叠访问主要出现在使用<code>in-out</code>参数的函数或方法  或者结构体的<code>mutating</code>方法里。</p>

<h2 id="toc_2">In-Out参数的访问冲突</h2>

<p>一个函数会对它所有的in-out参数进行长期写访问。in-out参数的写访问会在所有非in-out参数处理完成后开始，直到函数执行完毕位置。如果有多个in-out参数，则写访问开始的顺序和参数顺序一致。</p>

<ol>
<li><p>不能在访问以in-out形式传入后的原变量，即使作用域原则和访问权限允许--任何访问原变量的行为都会造成冲突<br/>
<img src="media/15660380397380/15661846253994.jpg" alt="" style="width:600px;"/></p>
<p>解决方案是 显示的拷贝一份<code>stepSize</code>：</p>
<pre><code class="language-swift">// 显式拷贝
var copyOfStepSize = stepSize<br/>
increment(&amp;copyOfStepSize)<br/>
// 更新原来的值<br/>
stepSize = copyOfStepSize<br/>
// stepSize 现在的值是 2
</code></pre></li>
<li><p>当向同一函数的多个in-out参数里传入同一个变量也会产生冲突，</p>
<pre><code class="language-swift">func balance(_ x: inout Int, _ y: inout Int) {
let sum = x + y<br/>
x = sum / 2<br/>
y = sum - x<br/>
}<br/>
var playerOneScore = 42<br/>
var playerTwoScore = 30<br/>
balance(&amp;playerOneScore, &amp;playerTwoScore)  // 正常<br/>
balance(&amp;playerOneScore, &amp;playerOneScore)<br/>
// 错误：playerOneScore 访问冲突
</code></pre>
<p>将 playerOneScore 作为参数同时传入就会产生冲突，因为它会发起两个写访问，同时访 问同一个的存储地址</p></li>
</ol>

<blockquote>
<p>注意:</p>

<p>因为操作符也是函数，它们也会对in-out参数进行长期访问</p>
</blockquote>

<h3 id="toc_3">方法里self的访问冲突</h3>

<p>一个结构体的<code>mutating</code>方法会在调用期间对<code>self</code>进行写访问</p>

<pre><code class="language-swift">extension Player {
    mutating func shareHealth(with teammate: inout Player) {
        balance(&amp;teammate.health, &amp;health)
    }
}

var oscar = Player(name: &quot;Oscar&quot;, health: 10, energy: 10)
var maria = Player(name: &quot;Maria&quot;, health: 5, energy: 10)
oscar.shareHealth(with: &amp;maria)  // 正常
</code></pre>

<p><img src="media/15660380397380/15661951218602.jpg" alt="" style="width:600px;"/></p>

<p>但是当如果</p>

<pre><code class="language-swift">oscar.shareHealth(with: &amp;oscar)
// 错误：oscar 访问冲突
</code></pre>

<p>因为 mutating方法在调用期间需要对self发起访问，而同时in-out参数也需要写访问。在方法里，<code>self</code>和<code>teammate</code>指向统一存储地址。对同一块内存进行访问，并且重叠，就会产生冲突。</p>

<h2 id="toc_4">属性的访问冲突</h2>

<p>结构体、元组和枚举都是值类型，由多个独立的值构成，所以修改值的一部分都是对于整个值的修改，意味着其中一个属性的读和写访问都需要访问整一个值。</p>

<ol>
<li><p>对元组元素的写访问重写会产生冲突</p>
<pre><code class="language-swift">var playerInformation = (health: 10, energy: 20)
balance(&amp;playerInformation.health, &amp;playerInformation.energy)<br/>
// 错误：playerInformation 的属性访问冲突
</code></pre>
<p>所以，在任何情况下，对于元组元素的写访问都需要对整个元组发起写访问。</p></li>
<li><p>对存储在全局变量的结构体属性写访问重叠</p>
<pre><code class="language-swift">var holly = Player(name: &quot;Holly&quot;, health: 10, energy: 10)
balance(&amp;holly.health, &amp;holly.energy)  // 错误
</code></pre>
<p>大多数对于结构体属性的访问都会安全的重叠。例如，将上面例子的变量改为本地变量而非全局变量，编译器即可保证其是安全的</p>
<pre><code class="language-swift">func someFunction() {
    var oscar = Player(name: &quot;Oscar&quot;, health: 10, energy: 10)<br/>
    balance(&amp;oscar.health, &amp;oscar.energy)  // 正常<br/>
}
</code></pre>
<p>此时编译器可以保证内存安全，因为两个存储尚需经任何情况下都不会互相影响。</p></li>
</ol>

<p>限制结构体属性的重叠访问对于保证内存安全不是必要的。保证内存安全是必要的，但因为访问独占权的要求比内存安全还要更严格——意味着即使有些代码违反了访问独占权的原则，也是内存安全的，所以如果编译器可以保证这种非专属的访问是安全的，那 Swift 就会允许这种行为的代码运行。特别是当你遵循下面的原则时，它可以保证结构体属性的重叠访问是安全的：</p>

<ul>
<li>你访问的是实例的存储属性，而不是计算属性或类的属性</li>
<li>结构体是本地变量的值，而非全局变量</li>
<li>结构体要么没有被闭包捕获，要么只被非逃逸闭包捕获了</li>
</ul>


		</div>

		

	</article>
  
	<div class="pagination">
	 <a class="prev" href="Swift_3.html">&larr; Older</a> 
<a href="archives.html">Blog Archives</a>
	 <a class="next" href="Swift_1.html">Newer &rarr;</a>  
	    
	</div>
</div>
 <aside class="sidebar"> 

	<section>
	  <h1>Categories</h1>
	  <ul id="recent_posts">
	  
	      <li class="post">
	        <a href="iOS%20%E5%BC%80%E5%8F%91%E6%A8%A1%E5%9D%97%E7%9F%A5%E8%AF%86.html"><strong>iOS 开发模块知识&nbsp;(172)</strong></a>
	         <p class="cat-children-p"> 
	        
	        	<a href="iOS%E7%BC%96%E8%AF%91.html">iOS编译&nbsp;(20)</a>&nbsp;&nbsp;
	        
	        	<a href="%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86&Block.html">内存管理&Block&nbsp;(18)</a>&nbsp;&nbsp;
	        
	        	<a href="RunTime.html">runtime&nbsp;(11)</a>&nbsp;&nbsp;
	        
	        	<a href="Concurrent-Programming.html">多线程&nbsp;(19)</a>&nbsp;&nbsp;
	        
	        	<a href="GPU&&%E6%B8%B2%E6%9F%93.html">GPU&&渲染&nbsp;(3)</a>&nbsp;&nbsp;
	        
	        	<a href="%E6%9E%B6%E6%9E%84%E5%AD%A6%E4%B9%A0.html">架构学习&nbsp;(8)</a>&nbsp;&nbsp;
	        
	        	<a href="%E7%AC%AC%E4%B8%89%E6%96%B9%E9%A1%B9%E7%9B%AE%E5%AD%A6%E4%B9%A0.html">第三方项目学习&nbsp;(20)</a>&nbsp;&nbsp;
	        
	        	<a href="%E9%A1%B9%E7%9B%AE%E7%9B%91%E6%8E%A7.html">项目监控&nbsp;(10)</a>&nbsp;&nbsp;
	        
	        	<a href="%E6%B5%8B%E8%AF%95.html">调试&&测试&nbsp;(5)</a>&nbsp;&nbsp;
	        
	        	<a href="Cocoapods.html">Cocoapods&nbsp;(4)</a>&nbsp;&nbsp;
	        
	        	<a href="%E6%A8%A1%E5%9D%97%E5%8C%96%E7%9F%A5%E8%AF%86%E5%AD%A6%E4%B9%A0.html">模块化知识学习&nbsp;(26)</a>&nbsp;&nbsp;
	        
	        	<a href="Instrument%E5%AD%A6%E4%B9%A0.html">Instrument学习&nbsp;(1)</a>&nbsp;&nbsp;
	        
	        	<a href="%E7%9F%A5%E8%AF%86%E7%82%B9.html">知识点&nbsp;(10)</a>&nbsp;&nbsp;
	        
	        	<a href="%E8%A1%A5%E5%85%85-1.html">补充&nbsp;(9)</a>&nbsp;&nbsp;
	        
	        	<a href="%E9%9D%A2%E8%AF%95.html">面试&nbsp;(8)</a>&nbsp;&nbsp;
	        
	         </p> 
	      </li>
	  
	      <li class="post">
	        <a href="Swift.html"><strong>Swift初学笔记&nbsp;(28)</strong></a>
	         <p class="cat-children-p"> 
	        
	        	<a href="Swift-BaseLearning.html">Swift基础知识&nbsp;(28)</a>&nbsp;&nbsp;
	        
	         </p> 
	      </li>
	  
	      <li class="post">
	        <a href="Computer-programming.html"><strong>计算机编程&nbsp;(2)</strong></a>
	        
	        
	        
	      </li>
	  
	      <li class="post">
	        <a href="iOSDevelop.html"><strong>iOSDevelop&nbsp;(27)</strong></a>
	         <p class="cat-children-p"> 
	        
	        	<a href="iOS%20%E5%B0%8F%E7%9F%A5%E8%AF%86.html">iOS 小知识&nbsp;(14)</a>&nbsp;&nbsp;
	        
	        	<a href="iOS%E5%BC%80%E5%8F%91%E7%9F%A5%E8%AF%86.html">iOS开发知识&nbsp;(12)</a>&nbsp;&nbsp;
	        
	         </p> 
	      </li>
	  
	      <li class="post">
	        <a href="JavaScript%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html"><strong>JavaScript学习笔记&nbsp;(41)</strong></a>
	         <p class="cat-children-p"> 
	        
	        	<a href="%E5%9F%BA%E7%A1%80.html">基础&nbsp;(11)</a>&nbsp;&nbsp;
	        
	        	<a href="%E7%9F%A5%E8%AF%86%E6%99%AE%E5%8F%8A.html">知识普及&nbsp;(1)</a>&nbsp;&nbsp;
	        
	        	<a href="Flex.html">Flex&nbsp;(2)</a>&nbsp;&nbsp;
	        
	        	<a href="ES6.html">ES6&nbsp;(17)</a>&nbsp;&nbsp;
	        
	        	<a href="React.html">React&nbsp;(10)</a>&nbsp;&nbsp;
	        
	         </p> 
	      </li>
	  
	      <li class="post">
	        <a href="React-Native.html"><strong>React-Native&nbsp;(6)</strong></a>
	        
	        
	        
	      </li>
	  
	      <li class="post">
	        <a href="Python.html"><strong>Python&nbsp;(14)</strong></a>
	        
	        
	        
	      </li>
	  
	      <li class="post">
	        <a href="%E7%AE%97%E6%B3%95%E5%AD%A6%E4%B9%A0.html"><strong>算法学习&nbsp;(2)</strong></a>
	         <p class="cat-children-p"> 
	        
	        	<a href="%E7%AE%97%E6%B3%95%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0.html">算法读书笔记&nbsp;(2)</a>&nbsp;&nbsp;
	        
	         </p> 
	      </li>
	   
	  </ul>
	</section>
	<section>
	  <h1>Recent Posts</h1>
	  <ul id="recent_posts">
	  
	      
		      <li class="post">
		        <a href="15680194937623.html">AFSecurityPolicy</a>
		      </li>
	     
	  
	      
		      <li class="post">
		        <a href="15680125238227.html">AFNetworkReachabilityManager</a>
		      </li>
	     
	  
	      
		      <li class="post">
		        <a href="15677400518331.html">AFURLSerialization</a>
		      </li>
	     
	  
	      
		      <li class="post">
		        <a href="15676621460215.html">AFURLSessionManager</a>
		      </li>
	     
	  
	      
		      <li class="post">
		        <a href="15675682575589.html">AFNetworking</a>
		      </li>
	     
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	   
	  </ul>
	</section>
	
</aside> </div></div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 -  -
  <span class="credit">Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a> &nbsp;&nbsp; Theme by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>

  
    




</body>
</html>