
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>
    
  ACEfish-Blog
  

  </title>
  <meta name="author" content="">
  <meta name="description" content="学习记录">

  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link href="asset/css/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="atom.xml" rel="alternate" title="ACEfish-Blog" type="application/atom+xml">
  <script src="asset/js/modernizr-2.0.js"></script>
  <script src="asset/js/jquery.min.js"></script>
  <script src="asset/highlightjs/highlight.pack.js"></script>
  <link href="asset/highlightjs/styles/solarized_light.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script>hljs.initHighlightingOnLoad();</script>

  <style type="text/css">
  .cat-children-p{ padding: 6px 0px;}
  .hljs{background: none;}
  </style>
  <script type="text/javascript">
  var isAddSildbar = true;
  </script>
  <script src="asset/js/octopress.js" type="text/javascript"></script>
</head>
<script type="text/javascript">
//链接新开窗口
function addBlankTargetForLinks () {
  $('a[href^="http"]').each(function(){
      $(this).attr('target', '_blank');
  });
}
$(document).ready(function(event) {
  addBlankTargetForLinks();
});
</script>
<body   >
  <header role="banner"><hgroup>
  <h1><a href="index.html">ACEfish-Blog</a></h1>
  
    <h2>学习记录</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:acefish.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">

  <li id=""><a target="_self" href="index.html">首页</a></li>

  <li id=""><a target="_self" href="archives.html">归档</a></li>

</ul>

</nav>
  <div id="main">
    <div id="content"> 
<div class="blog-index">

	<article>
		 <header>
		  	<h1 class="entry-title"><a href="15537643467312.html">iOS 编译 Clang 和 LLVM</a></h1>
			<p class="meta"><time datetime="2019-03-28T17:12:26+08:00" 
			pubdate data-updated="true">2019/3/28</time></p>
		 </header>
	  	<div class="entry-content">
		  	
		  	<p>本文学习自戴铭老师的<a href="https://github.com/ming1016/study/wiki/%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90-iOS-%E7%BC%96%E8%AF%91-Clang---LLVM">深入剖析 iOS 编译 Clang LLVM</a></p>

<h2 id="toc_0">LLVM</h2>

<p>LLVM( Low Level Virtual Machine)是swift之父开发的一款编译器开发工具套件，可以用于常规编译器，JIT编译器（JIT是一种提高程序运行效率的方法）、汇编器、调试器、静态分析工具等。其后来又开发了clang，</p>

<p>iOS开发中的OC就是用Clang/LLVM来编译的</p>

<p>Swift是swift/LLVM,其中Swift前端会多出来SIL optimizer（SIL优化器），把.swift生成的中间代码 .sil，因为swift在编译期间就完成了方法绑定直接通过地址调用属于强类型语言，方法调用不再需要像OC那样的消息发送，这样编译器可以获得更多信息在后面的后端优化上</p>

<p>LLVM是一个模块化和可重用的编译器和工具链技术的集合，Clang是LLVM的子集，是C、C++、Object-C的编译器，用来专门给Apple使用提供比GCC更快的编译速度。Clang提供了<code>clang static analyzer</code>即analyzer分析工具用于进行语法分析，语义分析和生成中间代码，这个过程会对代码进行检查，出错的和需要警告的会标注出来。<code>lld</code>是Clang/LLVM内置的链接器，clang必须调用链接器来产生可执行文件</p>

<p>LLVM 比较有特色的一点是它能提供一种代码编写良好的中间表示 IR（IR寄存器？），这意味着它可以作为多种语言的后端，这样就能够提供语言无关的优化同时还能够方便的针对多种 CPU 的代码生成</p>

<h2 id="toc_1">编译流程</h2>

<p>先写一个简单的例子程序来看一下程序如何运行</p>

<pre><code class="language-objectivec">#import &lt;Foundation/Foundation.h&gt;
#define DEFINEEight 8
int main(int argc, char * argv[]) {
    @autoreleasepool {
#pragma mark - Mark--
        int eight = DEFINEEight;
        int six = 6;
        char a = &#39;a&#39;;
        char *str = &quot;strTest&quot;;
        NSString *site = [[NSString alloc] initWithUTF8String:&quot;starming&quot;];
        int rank = eight + six;
        NSLog(@&quot;%@ rank %d&quot;, site, rank);
        printf(&quot;%s and %c&quot;, str, a);
//        return UIApplicationMain(argc, argv, nil, NSStringFromClass([AppDelegate class]));
    }
//    return 0;
}
</code></pre>

<p>查看<code>clang</code>编译的阶段</p>

<pre><code class="language-text">//在终端输入命令
clang -ccc-print-phases main.m

//总共有7步骤，
0: input, “main.m”, objective-c //输入文件
1: preprocessor, {0}, objective-c-cpp-output //预编译
2: compiler, {1}, ir //优化编译为中间代码IR,前端的输出、后端的输入
3: backend, {2}, assembler //编译为汇编语言
4: assembler, {3}, object //汇编为目标程序
5: linker, {4}, image //链接为可执行文件
6: bind-arch, “x86_64”, {5}, image 
</code></pre>

<p>查看OC代码的C语言实现:<br/>
<code>clang -rewrite-objc main.m</code>会生成一个main.cpp的C语言文件</p>

<pre><code class="language-c">//在文件的最后可以看到我们代码的实现
int main(int argc, char * argv[]) {
    /* @autoreleasepool */ { __AtAutoreleasePool __autoreleasepool; 
        int eight = 8;
        int six = 6;
        char a = &#39;a&#39;;
        char *str = &quot;strTest&quot;;
        NSString *site = ((NSString * _Nullable (*)(id, SEL, const char * _Nonnull))(void *)objc_msgSend)((id)((NSString *(*)(id, SEL))(void *)objc_msgSend)((id)objc_getClass(&quot;NSString&quot;), sel_registerName(&quot;alloc&quot;)), sel_registerName(&quot;initWithUTF8String:&quot;), (const char *)&quot;starming&quot;);
        int rank = eight + six;
        NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_m7_58pb6m6x3dqbv727djzdvbvw0000gn_T_main_3cf008_mi_0, site, rank);
        printf(&quot;%s and %c&quot;, str, a);

    }

}
</code></pre>

<p>查看操作内部命令，可以使用 -### 命令<br/>
clang -### main.m -o main</p>

<ol>
<li><p>查看clang的的预编译实现:<br/>
<code>clang -E main.m</code> 查看预编译的结果</p>
<pre><code class="language-objectivec">
//在预编译文件的最后可以看到我们代码的预编译结果<br/>
# 1 &quot;/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX10.14.sdk/System/Library/Frameworks/Foundation.framework/Headers/FoundationLegacySwiftCompatibility.h&quot; 1 3<br/>
# 185 &quot;/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX10.14.sdk/System/Library/Frameworks/Foundation.framework/Headers/Foundation.h&quot; 2 3<br/>
# 12 &quot;main.m&quot; 2<br/>
int main(int argc, char * argv[]) {<br/>
    @autoreleasepool {<br/>
        UIView *view = [[UIView alloc] init];<br/>
        view.backgroundColor = [UIColor redColor];<br/>
        int eight = 8;<br/>
        int six = 6;<br/>
        char a = &#39;a&#39;;<br/>
        char *str = &quot;strTest&quot;;<br/>
        NSString *site = [[NSString alloc] initWithUTF8String:&quot;starming&quot;];<br/>
        int rank = eight + six;<br/>
        NSLog(@&quot;%@ rank %d&quot;, site, rank);<br/>
        printf(&quot;%s and %c&quot;, str, a);<br/>
    }<br/>
}
</code></pre>
<p>在预编译的过程中做的事情有:</p>
<ul>
<li><code>#define</code>宏的替换</li>
<li><code>#include</code><code>#import</code>文件的导入</li>
<li><code>#indef</code></li>
<li>注释的去除</li>
<li><code>#pragma</code>的去除</li>
</ul></li>
<li><p>在预处理完成后进行词法分析，把代码编程一个个的token，比如大小括号，等于号还有字符串等,格式化代码<br/>
<code>clang -fmodules -fsyntax-only -Xclang -dump-tokens main.m</code></p></li>
<li><p>然后语法分析，验证语法是否正确，将所有节点组成抽象语法树AST<br/>
<code>clang -fmodules -fsyntax-only -Xclang -ast-dump main.m</code></p>
<p>下面为部分简单语句的AST结构:<br/>
//<code>int eight = 8;</code><br/>
<img src="media/15537643467312/15538400757623.jpg" alt="" style="width:880px;"/> <br/>
    //<code>char a = &#39;a&#39;;</code><br/>
<img src="media/15537643467312/15538401099554.jpg" alt="" style="width:840px;"/><br/>
    //<code>char *str = &quot;strTest&quot;;</code><br/>
<img src="media/15537643467312/15538401215169.jpg" alt="" style="width:878px;"/><br/>
    // <code>NSString *site = [[NSString alloc]  initWithUTF8String:&quot;starming&quot;];</code><br/>
<img src="media/15537643467312/15538401867042.jpg" alt="" style="width:880px;"/><br/>
//<code>NSLog(@&quot;%@ rank %d&quot;, site, rank);</code><br/>
<img src="media/15537643467312/15538403856423.jpg" alt="" style="width:830px;"/></p></li>
<li><p>完成这些步骤之后，就可以开始中间代码的生成了</p>
<p><code>CodeGen</code>会负责将语法树自上向下逐步翻译成<code>LLVM IR</code>，IR就是编译过程前端的输出、后端的输入</p>
<p>用命令行:<br/>
<code>clang -S -fobjc-arc -emit-llvm main.m -o main.ll</code><br/>
生成.ll文件即为IR中间代码<br/>
LLVM会在这一步做一些优化的事情，我们也可以在Xcode中设置优化级别<br/>
<img src="media/15537643467312/15538506827890.jpg" alt="" style="width:902px;"/><br/>
<img src="media/15537643467312/15538508218589.jpg" alt="" style="width:465px;"/></p>
<p>默认为在debug模式下为-O0.Release模式下为-Os</p>
<p>我们也可以使用命令行指定优化级别:</p>
<pre><code class="language-text">//指定优化级别为-O3
clang -O3 -S -fobjc-arc -emit-llvm main.m -o main.ll<br/>
最直接的结果,就是这两个优化命令，对我们的程序产生的IR文件分别为//108行代码 和81行代码
</code></pre>
<p>Pass 是 LLVM 优化工作的一个节点，一个节点做些事，一起加起来就构成了 LLVM 完整的优化和转化。</p>
<p>如果开启了<code>bitcode</code>苹果会做进一步的优化，有新的后端架构还是可以用这份优化过的 bitcode 去生成。</p>
<p><code>clang -emit-llvm -c main.m -o main.bc</code></p></li>
<li><p>编译生成汇编文件</p>
<pre><code class="language-text">//生成汇编文件 main.s
clang -S -fobjc-arc main.m -o main.s
</code></pre>
<p>下面是部分main.s汇编文件内容<br/>
<img src="media/15537643467312/15538515406816.jpg" alt="" style="width:638px;"/></p></li>
<li><p>汇编之后生成目标文件</p>
<pre><code class="language-text">//生成目标文件 main.o 此时内容就是一堆二进制了
clang -fmodules -c main.m -o main.o
</code></pre></li>
<li><p>链接后生成可执行文件</p>
<pre><code class="language-text">clang main.o -o main
</code></pre></li>
<li><p>执行可执行文件</p>
<pre><code class="language-text">执行
./main<br/>
输出<br/>
starming rank 14
</code></pre></li>
</ol>


		</div>

		

	</article>
  
	<div class="pagination">
	 <a class="prev" href="all_257.html">&larr; Older</a> 
<a href="archives.html">Blog Archives</a>
	 <a class="next" href="all_255.html">Newer &rarr;</a>  
	    
	</div>
</div>
 <aside class="sidebar"> 

	<section>
	  <h1>Categories</h1>
	  <ul id="recent_posts">
	  
	      <li class="post">
	        <a href="iOS%20%E5%BC%80%E5%8F%91%E6%A8%A1%E5%9D%97%E7%9F%A5%E8%AF%86.html"><strong>iOS 开发模块知识&nbsp;(188)</strong></a>
	         <p class="cat-children-p"> 
	        
	        	<a href="%E7%BD%91%E7%BB%9C.html">网络&nbsp;(2)</a>&nbsp;&nbsp;
	        
	        	<a href="iOS%E7%BC%96%E8%AF%91.html">iOS编译&nbsp;(20)</a>&nbsp;&nbsp;
	        
	        	<a href="%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86&Block.html">内存管理&Block&nbsp;(18)</a>&nbsp;&nbsp;
	        
	        	<a href="RunTime.html">runtime&nbsp;(11)</a>&nbsp;&nbsp;
	        
	        	<a href="Concurrent-Programming.html">多线程&nbsp;(19)</a>&nbsp;&nbsp;
	        
	        	<a href="GPU&&%E6%B8%B2%E6%9F%93.html">GPU&&渲染&nbsp;(3)</a>&nbsp;&nbsp;
	        
	        	<a href="%E6%9E%B6%E6%9E%84%E5%AD%A6%E4%B9%A0.html">架构学习&nbsp;(8)</a>&nbsp;&nbsp;
	        
	        	<a href="%E7%AC%AC%E4%B8%89%E6%96%B9%E9%A1%B9%E7%9B%AE%E5%AD%A6%E4%B9%A0.html">第三方项目学习&nbsp;(34)</a>&nbsp;&nbsp;
	        
	        	<a href="%E9%A1%B9%E7%9B%AE%E7%9B%91%E6%8E%A7.html">项目监控&nbsp;(10)</a>&nbsp;&nbsp;
	        
	        	<a href="%E6%B5%8B%E8%AF%95.html">调试&&测试&nbsp;(5)</a>&nbsp;&nbsp;
	        
	        	<a href="Cocoapods.html">Cocoapods&nbsp;(4)</a>&nbsp;&nbsp;
	        
	        	<a href="%E6%A8%A1%E5%9D%97%E5%8C%96%E7%9F%A5%E8%AF%86%E5%AD%A6%E4%B9%A0.html">模块化知识学习&nbsp;(26)</a>&nbsp;&nbsp;
	        
	        	<a href="Instrument%E5%AD%A6%E4%B9%A0.html">Instrument学习&nbsp;(1)</a>&nbsp;&nbsp;
	        
	        	<a href="%E7%9F%A5%E8%AF%86%E7%82%B9.html">知识点&nbsp;(10)</a>&nbsp;&nbsp;
	        
	        	<a href="%E8%A1%A5%E5%85%85-1.html">补充&nbsp;(9)</a>&nbsp;&nbsp;
	        
	        	<a href="%E9%9D%A2%E8%AF%95.html">面试&nbsp;(8)</a>&nbsp;&nbsp;
	        
	         </p> 
	      </li>
	  
	      <li class="post">
	        <a href="Swift.html"><strong>Swift初学笔记&nbsp;(28)</strong></a>
	         <p class="cat-children-p"> 
	        
	        	<a href="Swift-BaseLearning.html">Swift基础知识&nbsp;(28)</a>&nbsp;&nbsp;
	        
	         </p> 
	      </li>
	  
	      <li class="post">
	        <a href="Computer-programming.html"><strong>计算机编程&nbsp;(2)</strong></a>
	        
	        
	        
	      </li>
	  
	      <li class="post">
	        <a href="iOSDevelop.html"><strong>iOSDevelop&nbsp;(27)</strong></a>
	         <p class="cat-children-p"> 
	        
	        	<a href="iOS%20%E5%B0%8F%E7%9F%A5%E8%AF%86.html">iOS 小知识&nbsp;(14)</a>&nbsp;&nbsp;
	        
	        	<a href="iOS%E5%BC%80%E5%8F%91%E7%9F%A5%E8%AF%86.html">iOS开发知识&nbsp;(12)</a>&nbsp;&nbsp;
	        
	         </p> 
	      </li>
	  
	      <li class="post">
	        <a href="JavaScript%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html"><strong>JavaScript学习笔记&nbsp;(41)</strong></a>
	         <p class="cat-children-p"> 
	        
	        	<a href="%E5%9F%BA%E7%A1%80.html">基础&nbsp;(11)</a>&nbsp;&nbsp;
	        
	        	<a href="%E7%9F%A5%E8%AF%86%E6%99%AE%E5%8F%8A.html">知识普及&nbsp;(1)</a>&nbsp;&nbsp;
	        
	        	<a href="Flex.html">Flex&nbsp;(2)</a>&nbsp;&nbsp;
	        
	        	<a href="ES6.html">ES6&nbsp;(17)</a>&nbsp;&nbsp;
	        
	        	<a href="React.html">React&nbsp;(10)</a>&nbsp;&nbsp;
	        
	         </p> 
	      </li>
	  
	      <li class="post">
	        <a href="React-Native.html"><strong>React-Native&nbsp;(6)</strong></a>
	        
	        
	        
	      </li>
	  
	      <li class="post">
	        <a href="Python.html"><strong>Python&nbsp;(14)</strong></a>
	        
	        
	        
	      </li>
	  
	      <li class="post">
	        <a href="%E7%AE%97%E6%B3%95%E5%AD%A6%E4%B9%A0.html"><strong>算法学习&nbsp;(2)</strong></a>
	         <p class="cat-children-p"> 
	        
	        	<a href="%E7%AE%97%E6%B3%95%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0.html">算法读书笔记&nbsp;(2)</a>&nbsp;&nbsp;
	        
	         </p> 
	      </li>
	   
	  </ul>
	</section>
	<section>
	  <h1>Recent Posts</h1>
	  <ul id="recent_posts">
	  
	      
		      <li class="post">
		        <a href="15710288132412.html">Collections and asynchronous updates</a>
		      </li>
	     
	  
	      
		      <li class="post">
		        <a href="15710248960458.html">Layout Specs</a>
		      </li>
	     
	  
	      
		      <li class="post">
		        <a href="15707800044047.html">Node Lifecycle</a>
		      </li>
	     
	  
	      
		      <li class="post">
		        <a href="15707737201639.html">线程</a>
		      </li>
	     
	  
	      
		      <li class="post">
		        <a href="15698393226216.html">Nodes</a>
		      </li>
	     
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	   
	  </ul>
	</section>
	
</aside> </div></div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 -  -
  <span class="credit">Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a> &nbsp;&nbsp; Theme by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>

  
    




</body>
</html>