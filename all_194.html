
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>
    
  ACEfish-Blog
  

  </title>
  <meta name="author" content="">
  <meta name="description" content="学习记录">

  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link href="asset/css/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="atom.xml" rel="alternate" title="ACEfish-Blog" type="application/atom+xml">
  <script src="asset/js/modernizr-2.0.js"></script>
  <script src="asset/js/jquery.min.js"></script>
  <script src="asset/highlightjs/highlight.pack.js"></script>
  <link href="asset/highlightjs/styles/solarized_light.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script>hljs.initHighlightingOnLoad();</script>

  <style type="text/css">
  .cat-children-p{ padding: 6px 0px;}
  .hljs{background: none;}
  </style>
  <script type="text/javascript">
  var isAddSildbar = true;
  </script>
  <script src="asset/js/octopress.js" type="text/javascript"></script>
</head>
<script type="text/javascript">
//链接新开窗口
function addBlankTargetForLinks () {
  $('a[href^="http"]').each(function(){
      $(this).attr('target', '_blank');
  });
}
$(document).ready(function(event) {
  addBlankTargetForLinks();
});
</script>
<body   >
  <header role="banner"><hgroup>
  <h1><a href="index.html">ACEfish-Blog</a></h1>
  
    <h2>学习记录</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:acefish.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">

  <li id=""><a target="_self" href="index.html">首页</a></li>

  <li id=""><a target="_self" href="archives.html">归档</a></li>

</ul>

</nav>
  <div id="main">
    <div id="content"> 
<div class="blog-index">

	<article>
		 <header>
		  	<h1 class="entry-title"><a href="15553160787382.html">内存管理实践</a></h1>
			<p class="meta"><time datetime="2019-04-15T16:14:38+08:00" 
			pubdate data-updated="true">2019/4/15</time></p>
		 </header>
	  	<div class="entry-content">
		  	
		  	<p>尽管内存管理规则是简单的，但是我们可以通过一些实用的步骤来使内存管理更加稳健、高效</p>

<h2 id="toc_0">使用访问器方法来简化内存管理</h2>

<p>假如类有一个对象属性时，我们需要确保赋值给属性的对象不会被<code>deallocted</code>，因此需要持有该对象而且需要释放当前属性对象；我们应该使用访问器方法来避免在代码中大量使用<code>release</code>和<code>retain</code>方法</p>

<pre><code class="language-objectivec">@interface Counter : NSObject
@property (nonatomic, retain) NSNumber *count;
@end;

//get访问器方法 只需要直接返回该对象，无需retain或者release
- (NSNumber *)count {
    return _count;
}

//set访问器方法，需要先持有newCount 释放oldCount的持有权
- (void)setCount:(NSNumber *)newCount {
    [newCount retain];
    [_count release];
    // Make the new assignment.
    _count = newCount;
}
</code></pre>

<blockquote>
<p>因为在OC中是可以给nil发送消息的，因此即使newCount为空也是有效的<br/>
必须先retain后release，因为避免两个count为同一个对象，导致对象不经意间被释放</p>
</blockquote>

<h3 id="toc_1">使用访问器方法设置属性值</h3>

<p>假如想要重置属性值可以使用以下两种方法</p>

<pre><code class="language-objectivec">//因为使用alloc 所以需要release
- (void)reset {
    NSNumber *zero = [[NSNumber alloc] initWithInteger:0];
    [self setCount:zero];
    [zero release];
}

- (void)reset {
    NSNumber *zero = [NSNumber numberWithInteger:0];
    [self setCount:zero];
}
</code></pre>

<p>以上两种方法都使用了set访问器方法</p>

<p>应该尽量避免下面的写法,虽然其在简单情况下也会正常，但是这样做很容易导致出错</p>

<pre><code class="language-objectivec">- (void)reset {
    NSNumber *zero = [[NSNumber alloc] initWithInteger:0];
    [_count release];
    _count = zero;
}
</code></pre>

<blockquote>
<p>假如你使用KVO，这样写是不符合KVO标准的</p>
</blockquote>

<h3 id="toc_2">不要在初始化方法和dealloc方法中使用访问器方法</h3>

<p><strong>唯一不应该使用访问器方法设置实例变量的地方就是在初始化方法和dealloc方法中</strong></p>

<pre><code class="language-objectivec">- init {
    self = [super init];
    if (self) {
        _count = [[NSNumber alloc] initWithInteger:0];
    }
    return self;
}

- initWithCount:(NSNumber *)startingCount {
    self = [super init];
    if (self) {
        _count = [startingCount copy];
    }
    return self;
}
</code></pre>

<p>因为<code>Counter Class</code>有一个实例变量对象，所以必须完成<code>dealloc</code>方法来释放所有的实例变量对象</p>

<pre><code class="language-objectivec">- (void)dealloc {
    [_count release];
    [super dealloc];
}
</code></pre>

<h2 id="toc_3">使用弱引用避免循环引用</h2>

<p>当retain一个对象时就对该对象创建一个<em>强引用</em>。一个对象在它的所有的强引用被释放前不会被<code>deallocated</code>。因此，假如两个对象互相引用(或者引用链最后一个对象又引用第一个对象)就有可能造成循环引用</p>

<p>解决循环引用就是使用<em>弱引用</em>，弱引用中源对象并不持有引用对象；因此按照Cocoa惯例:&quot;父对象&quot;强引用他的&quot;子对象&quot;，而&quot;子对象&quot;弱引用&quot;父对象&quot;<br/>
<img src="media/15553160787382/15553237100030.jpg" alt="" style="width:300px;"/></p>

<p>常用的弱引用:  table data sources、视图、notication observers、delegate等</p>

<p>使用弱引用需要注意，避免向已经<code>deallocated</code>的对象发送消息，否则会引起崩溃；因此弱引用对象使用时一般知道另外对象对其的弱引用，并在对象deallocated时通知两外一个对象。例如，向<code>notification center</code>注册接收对象时，通知中心会保留对该对象的弱引用，来在通知时给其发送通知消息。而在<code>deallocated</code>后，向<code>notification center</code>注销该对象，避免再次向其发送消息; 同样的，当取消分配的delegate时，需要<code>setDelegate：</code>为<code>nil</code>，这些消息常在<code>deallco</code>方法中发送。</p>

<h2 id="toc_4">避免正在使用的对象内存销毁</h2>

<p>我们在使用内存规则时保证对象在使用时是有效的，但是注意在以下两种情况可能导致出现异常情况:</p>

<ol>
<li><p>当一个对象从集合中移除</p>
<pre><code class="language-objectivec">heisenObject = [array objectAtIndex:n];
[array removeObjectAtIndex:n];<br/>
//heisenObject 此时可能已经无效了
</code></pre>
<p>当对象从集合汇总移除时，会发送一个<code>release</code>消息，此时如果集合是该对象唯一持有者，该对象就会被销毁</p></li>
<li><p>当&quot;父对象&quot;被销毁时</p>
<pre><code class="language-objectivec">id parent = &lt;#create a parent object#&gt;;
// ...<br/>
heisenObject = [parent child] ;<br/>
[parent release]; // Or, for example: self.parent = nil;<br/>
// heisenObject could now be invalid.
</code></pre>
<p>当使用子对象时，其父对象被释放导致被销毁，那么子对象也会被释放，而如果其父对象是其唯一的持有者，那么子对象也会被同时销毁</p></li>
</ol>

<p>为了避免出现以上两种情况，应该在收到该对象时retain，而在不再使用时release</p>

<pre><code class="language-objectivec">heisenObject = [[array objectAtIndex:n] retain];
[array removeObjectAtIndex:n];
// Use heisenObject...
[heisenObject release];
</code></pre>

<h2 id="toc_5">不要在dealloc中管理稀缺系统资源</h2>

<p>不应该在<code>dealloc</code>中管理稀缺资源，例如文件描述符、网络连接以及缓冲区和缓存。更不应该在你认为dealloc将调用是调用dealloc方法，因为dealloc的调用可能会因为bug或者应用终止而导致延迟或者不调用</p>

<p>相反，可以设计一个类，在不再需要这些稀缺系统资源时，进行“清理”。</p>

<p>在dealloc中进行资源管理可能会导致以下问题:</p>

<ol>
<li><p>视图拆除的顺序的依赖性<br/>
对象视图拆除机制本质上是无序的。虽然我们经常会获得期待的拆除顺序，但是这会给项目带来脆弱性。例如如果对象因为意外autorelease而不是release，拆除顺序就有可能改变</p></li>
<li><p>稀缺资源的未回收<br/>
内存管理时，内存泄漏是应该修复的错误，但是通常不会立刻致命。但是如果是该释放的资源没有立即释放就有可能遇到更严重的问题。例如，用完了文件描述符导致应用无法再存储数据</p></li>
<li><p>清理逻辑在错误的线程中执行</p>
<p>如果<strong>一个对象意外的autorelease，它将会在释放时碰巧遇到的任何线程的自动释放池中释放</strong>。而这对于那些只能在某个线程中释放的资源，是很致命的</p></li>
</ol>

<h2 id="toc_6">集合持有它所包含的元素对象</h2>

<p>将对象添加到集合中，集合就会持有该对象，即强引用该对象。而当集合中移除对象或者该集合本身被释放，集合将release该对象。因此，例如，假如你想要创建一组数组集合，可以这么做:</p>

<pre><code class="language-objectivec">NSMutableArray *array = &lt;#Get a mutable array#&gt;;
NSUInteger i;
// ...
for (i = 0; i &lt; 10; i++) {
    NSNumber *convenienceNumber = [NSNumber numberWithInteger:i];
    [array addObject:convenienceNumber];
}
</code></pre>

<p>这样写，因为不是alloc调用的的，因此不必release。而我们也必要retain数字对象，因为数组会对其进行retain</p>

<pre><code class="language-objectivec">NSMutableArray *array = &lt;#Get a mutable array#&gt;;
NSUInteger i;
// ...
for (i = 0; i &lt; 10; i++) {
    NSNumber *allocedNumber = [[NSNumber alloc] initWithInteger:i];
    [array addObject:allocedNumber];
    [allocedNumber release];
}
</code></pre>

<p>在这个例子中，for循环中，因为是<code>allocNumber</code>产生的对象因此需要release进行平衡</p>

<h2 id="toc_7">使用引用计数来进行持有策略</h2>

<p>引用计数，通常在retain后称为保留计数，每个对象都有一个保留计数</p>

<ul>
<li>创建对象时，保留计数为1</li>
<li>向对象发送保留消息，其保留计数加1</li>
<li>向对象发送释放消息，保留计数减1</li>
<li>向对象发送自动释放消息，保留计数在当前自动释放池末尾，保留计数减1</li>
<li>当保留计数为0，则将其<code>deallocated</code>即销毁对象释放内存<br/>
</li>
</ul>


		</div>

		

	</article>
  
	<div class="pagination">
	 <a class="prev" href="all_195.html">&larr; Older</a> 
<a href="archives.html">Blog Archives</a>
	 <a class="next" href="all_193.html">Newer &rarr;</a>  
	    
	</div>
</div>
 <aside class="sidebar"> 

	<section>
	  <h1>Categories</h1>
	  <ul id="recent_posts">
	  
	      <li class="post">
	        <a href="iOS%20%E5%BC%80%E5%8F%91%E6%A8%A1%E5%9D%97%E7%9F%A5%E8%AF%86.html"><strong>iOS 开发模块知识&nbsp;(150)</strong></a>
	         <p class="cat-children-p"> 
	        
	        	<a href="iOS%E7%BC%96%E8%AF%91.html">iOS编译&nbsp;(19)</a>&nbsp;&nbsp;
	        
	        	<a href="%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.html">内存管理&nbsp;(14)</a>&nbsp;&nbsp;
	        
	        	<a href="RunTime.html">runtime&nbsp;(11)</a>&nbsp;&nbsp;
	        
	        	<a href="Concurrent-Programming.html">多线程&nbsp;(18)</a>&nbsp;&nbsp;
	        
	        	<a href="%E6%9E%B6%E6%9E%84%E5%AD%A6%E4%B9%A0.html">架构学习&nbsp;(8)</a>&nbsp;&nbsp;
	        
	        	<a href="%E7%AC%AC%E4%B8%89%E6%96%B9%E9%A1%B9%E7%9B%AE%E5%AD%A6%E4%B9%A0.html">第三方项目学习&nbsp;(8)</a>&nbsp;&nbsp;
	        
	        	<a href="%E9%A1%B9%E7%9B%AE%E7%9B%91%E6%8E%A7.html">项目监控&nbsp;(8)</a>&nbsp;&nbsp;
	        
	        	<a href="%E9%A1%B9%E7%9B%AE%E4%BC%98%E5%8C%96.html">项目优化&nbsp;(1)</a>&nbsp;&nbsp;
	        
	        	<a href="%E6%B5%8B%E8%AF%95.html">调试&&测试&nbsp;(5)</a>&nbsp;&nbsp;
	        
	        	<a href="Cocoapods.html">Cocoapods&nbsp;(4)</a>&nbsp;&nbsp;
	        
	        	<a href="%E6%A8%A1%E5%9D%97%E5%8C%96%E7%9F%A5%E8%AF%86%E5%AD%A6%E4%B9%A0.html">模块化知识学习&nbsp;(26)</a>&nbsp;&nbsp;
	        
	        	<a href="Instrument%E5%AD%A6%E4%B9%A0.html">Instrument学习&nbsp;(1)</a>&nbsp;&nbsp;
	        
	        	<a href="%E7%9F%A5%E8%AF%86%E7%82%B9.html">知识点&nbsp;(10)</a>&nbsp;&nbsp;
	        
	        	<a href="%E8%A1%A5%E5%85%85-1.html">补充&nbsp;(9)</a>&nbsp;&nbsp;
	        
	        	<a href="%E9%9D%A2%E8%AF%95.html">面试&nbsp;(8)</a>&nbsp;&nbsp;
	        
	         </p> 
	      </li>
	  
	      <li class="post">
	        <a href="Swift.html"><strong>Swift初学笔记&nbsp;(26)</strong></a>
	         <p class="cat-children-p"> 
	        
	        	<a href="Swift-BaseLearning.html">Swift基础知识&nbsp;(26)</a>&nbsp;&nbsp;
	        
	         </p> 
	      </li>
	  
	      <li class="post">
	        <a href="Computer-programming.html"><strong>计算机编程&nbsp;(2)</strong></a>
	        
	        
	        
	      </li>
	  
	      <li class="post">
	        <a href="iOSDevelop.html"><strong>iOSDevelop&nbsp;(27)</strong></a>
	         <p class="cat-children-p"> 
	        
	        	<a href="iOS%20%E5%B0%8F%E7%9F%A5%E8%AF%86.html">iOS 小知识&nbsp;(14)</a>&nbsp;&nbsp;
	        
	        	<a href="iOS%E5%BC%80%E5%8F%91%E7%9F%A5%E8%AF%86.html">iOS开发知识&nbsp;(12)</a>&nbsp;&nbsp;
	        
	         </p> 
	      </li>
	  
	      <li class="post">
	        <a href="JavaScript%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html"><strong>JavaScript学习笔记&nbsp;(40)</strong></a>
	         <p class="cat-children-p"> 
	        
	        	<a href="%E5%9F%BA%E7%A1%80.html">基础&nbsp;(11)</a>&nbsp;&nbsp;
	        
	        	<a href="%E7%9F%A5%E8%AF%86%E6%99%AE%E5%8F%8A.html">知识普及&nbsp;(1)</a>&nbsp;&nbsp;
	        
	        	<a href="Flex.html">Flex&nbsp;(2)</a>&nbsp;&nbsp;
	        
	        	<a href="ES6.html">ES6&nbsp;(17)</a>&nbsp;&nbsp;
	        
	        	<a href="React.html">React&nbsp;(9)</a>&nbsp;&nbsp;
	        
	         </p> 
	      </li>
	  
	      <li class="post">
	        <a href="React-Native.html"><strong>React-Native&nbsp;(6)</strong></a>
	        
	        
	        
	      </li>
	  
	      <li class="post">
	        <a href="Python.html"><strong>Python&nbsp;(14)</strong></a>
	        
	        
	        
	      </li>
	   
	  </ul>
	</section>
	<section>
	  <h1>Recent Posts</h1>
	  <ul id="recent_posts">
	  
	      
		      <li class="post">
		        <a href="15578383647199.html">RACSignal</a>
		      </li>
	     
	  
	      
		      <li class="post">
		        <a href="15578193513091.html">RACStream</a>
		      </li>
	     
	  
	      
		      <li class="post">
		        <a href="15560883411509.html">MatrixiOS学习</a>
		      </li>
	     
	  
	      
		      <li class="post">
		        <a href="15559005276972.html">Mach-O文件结构</a>
		      </li>
	     
	  
	      
		      <li class="post">
		        <a href="15556625620569.html">pod repo update</a>
		      </li>
	     
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	   
	  </ul>
	</section>
	
</aside> </div></div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 -  -
  <span class="credit">Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a> &nbsp;&nbsp; Theme by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>

  
    




</body>
</html>